<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">

<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="源码,">





  <link rel="alternate" href="/atom.xml" title="cuzz's blog" type="application/atom+xml">






<meta name="description" content="&amp;#x7248;&amp;#x672C; 4.1.15    &amp;#x5B98;&amp;#x7F51;&amp;#xFF1A;https://netty.io/  Netty is an asynchronous event-driven network application framework  for rapid development of maintainable high performance protoc">
<meta name="keywords" content="源码">
<meta property="og:type" content="article">
<meta property="og:title" content="Netty 源码分析（四）">
<meta property="og:url" content="http://blog.cuzz.site/2019/01/19/Netty 源码分析（四）/index.html">
<meta property="og:site_name" content="cuzz&#39;s blog">
<meta property="og:description" content="&amp;#x7248;&amp;#x672C; 4.1.15    &amp;#x5B98;&amp;#x7F51;&amp;#xFF1A;https://netty.io/  Netty is an asynchronous event-driven network application framework  for rapid development of maintainable high performance protoc">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://blog.cuzz.site/2019/01/19/Netty%20源码分析（四）/Netty%20源码分析（四）/20190118000012.png">
<meta property="og:image" content="http://blog.cuzz.site/2019/01/19/Netty%20源码分析（四）/Netty%20源码分析（四）/ByteBuf%20internal%20segmentation.jpg">
<meta property="og:updated_time" content="2019-07-16T11:43:31.300Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Netty 源码分析（四）">
<meta name="twitter:description" content="&amp;#x7248;&amp;#x672C; 4.1.15    &amp;#x5B98;&amp;#x7F51;&amp;#xFF1A;https://netty.io/  Netty is an asynchronous event-driven network application framework  for rapid development of maintainable high performance protoc">
<meta name="twitter:image" content="http://blog.cuzz.site/2019/01/19/Netty%20源码分析（四）/Netty%20源码分析（四）/20190118000012.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.cuzz.site/2019/01/19/Netty 源码分析（四）/">






  <title>Netty 源码分析（四） | cuzz's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?415372bd35fec36f7558dd96b48ec03f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

<a href="https://github.com/cuzz1" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">cuzz's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">填坑之路(Github托管)</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.cuzz.site/2019/01/19/Netty 源码分析（四）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cuzz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cuzz's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Netty 源码分析（四）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-19T00:00:07+08:00">
                2019-01-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,116
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  20
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&#x7248;&#x672C; 4.1.15   </p>
<p>&#x5B98;&#x7F51;&#xFF1A;<a href="https://netty.io/" target="_blank" rel="noopener">https://netty.io/</a></p>
<blockquote>
<p>Netty is <em>an asynchronous event-driven network application framework</em>  for rapid development of maintainable high performance protocol servers &amp; clients. </p>
</blockquote>
<a id="more"></a>
<h2 id="ChannelPromise"><a href="#ChannelPromise" class="headerlink" title="ChannelPromise"></a>ChannelPromise</h2><p>io.netty.channel.ChannelPromise</p>
<p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E86; <code>ChannelFuture</code> &#xFF0C;&#x770B;&#x770B;<code>ChannelPromise</code> &#x7684;&#x4F5C;&#x7528;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Special {<span class="doctag">@link</span> ChannelFuture} which is writable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ChannelPromise</span> <span class="keyword">extends</span> <span class="title">ChannelFuture</span>, <span class="title">Promise</span>&lt;<span class="title">Void</span>&gt; </span>{ ... }</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x5199;&#x5165;&#x7684; <code>ChannelFuture</code> &#xFF0C;&#x6211;&#x5148;&#x770B;&#x770B; <code>Promise</code> &#x8FD9;&#x4E2A;&#x7C7B;</p>
<h3 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h3><p>io.netty.util.concurrent.Promise</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Promise</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marks this future as a success and notifies all</span></span><br><span class="line"><span class="comment">     * listeners.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If it is success or failed already it will throw an {<span class="doctag">@link</span> IllegalStateException}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">setSuccess</span><span class="params">(V result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marks this future as a success and notifies all</span></span><br><span class="line"><span class="comment">     * listeners.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> {<span class="doctag">@code</span> true} if and only if successfully marked this future as</span></span><br><span class="line"><span class="comment">     *         a success. Otherwise {<span class="doctag">@code</span> false} because this future is</span></span><br><span class="line"><span class="comment">     *         already marked as either a success or a failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">trySuccess</span><span class="params">(V result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marks this future as a failure and notifies all</span></span><br><span class="line"><span class="comment">     * listeners.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If it is success or failed already it will throw an {<span class="doctag">@link</span> IllegalStateException}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">setFailure</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marks this future as a failure and notifies all</span></span><br><span class="line"><span class="comment">     * listeners.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> {<span class="doctag">@code</span> true} if and only if successfully marked this future as</span></span><br><span class="line"><span class="comment">     *         a failure. Otherwise {<span class="doctag">@code</span> false} because this future is</span></span><br><span class="line"><span class="comment">     *         already marked as either a success or a failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryFailure</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Make this future impossible to cancel.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> {<span class="doctag">@code</span> true} if and only if successfully marked this future as uncancellable or it is already done</span></span><br><span class="line"><span class="comment">     *         without being cancelled.  {<span class="doctag">@code</span> false} if this future has been cancelled already.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setUncancellable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">awaitUninterruptibly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">syncUninterruptibly</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>JDK &#x6240;&#x63D0;&#x4F9B;&#x7684;&#x7684; Future &#x53EA;&#x80FD;&#x901A;&#x8FC7;&#x624B;&#x5DE5;&#x7684;&#x65B9;&#x5F0F;&#x68C0;&#x67E5;&#x6267;&#x884C;&#x7ED3;&#x679C;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x662F;&#x4F1A;&#x963B;&#x585E;&#x7684;&#xFF1B;Netty &#x5219;&#x5BF9; ChannelFutre &#x8FDB;&#x884C;&#x4E86;&#x589E;&#x5F3A;&#xFF0C;&#x901A;&#x8FC7; ChannelFutureListener &#x4EE5;&#x56DE;&#x8C03;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x83B7;&#x53D6;&#x6267;&#x884C;&#x7ED3;&#x679C;&#xFF0C;&#x53BB;&#x9664;&#x4E86;&#x624B;&#x5DE5;&#x68C0;&#x67E5;&#x963B;&#x585E;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;ChannelFutrureListener &#x7684; operationComplete &#x65B9;&#x6CD5;&#x662F;&#x7531;I/O&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x4E0D;&#x8981;&#x5728;&#x8FD9;&#x91CC;&#x6267;&#x884C;&#x8017;&#x65F6;&#x64CD;&#x4F5C;&#xFF0C;&#x5426;&#x5219;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x53E6;&#x5916;&#x7684;&#x7EBF;&#x7A0B;&#x6216;&#x7EBF;&#x7A0B;&#x6C60;&#x6765;&#x6267;&#x884C;</p>
<h2 id="ChannelInboundHandlerAdapter"><a href="#ChannelInboundHandlerAdapter" class="headerlink" title="ChannelInboundHandlerAdapter"></a>ChannelInboundHandlerAdapter</h2><p>io.netty.channel.ChannelInboundHandlerAdapter</p>
<blockquote>
<p>io.netty.channel<br>public class ChannelInboundHandlerAdapter<br>extends ChannelHandlerAdapter</p>
<p>implements ChannelInboundHandlerAbstract base class for ChannelInboundHandler implementations which provide implementations of all of their methods.</p>
<p>This implementation just forward the operation to the next ChannelHandler in the ChannelPipeline. Sub-classes may override a method implementation to change this.</p>
<p>Be aware that messages are not released after the channelRead(ChannelHandlerContext, Object) method returns automatically. If you are looking for a ChannelInboundHandler implementation that releases the received messages automatically, please see SimpleChannelInboundHandler.</p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;&#x9002;&#x914D;&#x5668;&#x6A21;&#x5F0F;</p>
<h3 id="ChannelInboundHandler"><a href="#ChannelInboundHandler" class="headerlink" title="ChannelInboundHandler"></a>ChannelInboundHandler</h3><p>io.netty.channel.ChannelInboundHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelHandler} which adds callbacks for state changes. This allows the user</span></span><br><span class="line"><span class="comment"> * to hook in to state changes easily.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ChannelInboundHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The {<span class="doctag">@link</span> Channel} of the {<span class="doctag">@link</span> ChannelHandlerContext} was registered with its {<span class="doctag">@link</span> EventLoop}</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The {<span class="doctag">@link</span> Channel} of the {<span class="doctag">@link</span> ChannelHandlerContext} was unregistered from its {<span class="doctag">@link</span> EventLoop}</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelUnregistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The {<span class="doctag">@link</span> Channel} of the {<span class="doctag">@link</span> ChannelHandlerContext} is now active</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The {<span class="doctag">@link</span> Channel} of the {<span class="doctag">@link</span> ChannelHandlerContext} was registered is now inactive and reached its</span></span><br><span class="line"><span class="comment">     * end of lifetime.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked when the current {<span class="doctag">@link</span> Channel} has read a message from the peer.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked when the last message read by the current read operation has been consumed by</span></span><br><span class="line"><span class="comment">     * {<span class="doctag">@link</span> #channelRead(ChannelHandlerContext, Object)}.  If {<span class="doctag">@link</span> ChannelOption#AUTO_READ} is off, no further</span></span><br><span class="line"><span class="comment">     * attempt to read an inbound data from the current {<span class="doctag">@link</span> Channel} will be made until</span></span><br><span class="line"><span class="comment">     * {<span class="doctag">@link</span> ChannelHandlerContext#read()} is called.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets called if an user event was triggered.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets called once the writable state of a {<span class="doctag">@link</span> Channel} changed. You can check the state with</span></span><br><span class="line"><span class="comment">     * {<span class="doctag">@link</span> Channel#isWritable()}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets called if a {<span class="doctag">@link</span> Throwable} was thrown.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">&quot;deprecation&quot;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="SimpleChannelInboundHandler"><a href="#SimpleChannelInboundHandler" class="headerlink" title="SimpleChannelInboundHandler"></a>SimpleChannelInboundHandler</h2><p>io.netty.channel.SimpleChannelInboundHandler</p>
<p>&#x6211;&#x4EEC;&#x5728;&#x5199;&#x81EA;&#x5DF1;&#x7684; Handler &#x7684;&#x65F6;&#x5019;&#x957F;&#x4F1A;&#x7EE7;&#x627F;&#x8FD9;&#x4E2A; SimpleChannelInboundHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt;</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, String msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(ctx.channel().remoteAddress() + <span class="string">&quot;: &quot;</span> + msg);</span><br><span class="line">        ctx.channel().writeAndFlush(<span class="string">&quot;from server: &quot;</span> + UUID.randomUUID());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#x51FA;&#x73B0;&#x5F02;&#x5E38;&#x5173;&#x95ED;&#x8FDE;&#x63A5;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x770B;&#x770B;&#x8FD9;&#x4E2A;&#x6587;&#x6863;</p>
<blockquote>
<p>io.netty.channel<br>public abstract class SimpleChannelInboundHandler<i><br>extends ChannelInboundHandlerAdapter<br>ChannelInboundHandlerAdapter which allows to explicit only handle a specific type of messages. For example here is an implementation which only handle String messages.</i></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringHandler</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">&gt;     <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="meta">@Override</span></span><br><span class="line">&gt;     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, String message)</span></span></span><br><span class="line"><span class="function">&gt;         <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">&gt;         System.out.println(message);</span><br><span class="line">&gt;     }</span><br><span class="line">&gt; }</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>Be aware that depending of the constructor parameters it will release all handled messages by passing them to ReferenceCountUtil.release(Object). In this case you may need to use ReferenceCountUtil.retain(Object) if you pass the object to the next handler in the ChannelPipeline.<br>Forward compatibility notice</p>
</blockquote>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6CDB;&#x578B;&#x6307;&#x5B9A;&#x6D88;&#x606F;&#x7C7B;&#x578B;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">boolean</span> release = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (acceptInboundMessage(msg)) {</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">&quot;unchecked&quot;</span>)</span><br><span class="line">            I imsg = (I) msg;</span><br><span class="line">            channelRead0(ctx, imsg);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            release = <span class="keyword">false</span>;</span><br><span class="line">            ctx.fireChannelRead(msg);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (autoRelease &amp;&amp; release) {</span><br><span class="line">            <span class="comment">// &#x628A;&#x8FD9;&#x4E2A;&#x6D88;&#x606F;&#x8BA1;&#x6570;&#x51CF;&#x4E00;&#xFF0C;&#x5F53;&#x51CF;&#x4E3A;0&#x5C31;&#x4E22;&#x5F03;</span></span><br><span class="line">            ReferenceCountUtil.release(msg);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;strong&gt;Please keep in mind that this method will be renamed to</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> messageReceived(ChannelHandlerContext, I)} in 5.0.&lt;/strong&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Is called for each message of type {<span class="doctag">@link</span> I}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ctx           the {<span class="doctag">@link</span> ChannelHandlerContext} which this {<span class="doctag">@link</span> SimpleChannelInboundHandler}</span></span><br><span class="line"><span class="comment"> *                      belongs to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg           the message to handle</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception    is thrown if an error occurred</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, I msg)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>
<p>&#x7ED9;&#x6211;&#x4EEC;&#x5F3A;&#x5236;&#x8F6C;&#x6362;&#x4E3A;&#x7279;&#x5B9A;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x518D;&#x8C03;&#x7528; channelRead0 &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x65B9;&#x6CD5;&#xFF0C;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x53BB;&#x5B9E;&#x73B0;</p>
<h3 id="ReferenceCounted"><a href="#ReferenceCounted" class="headerlink" title="ReferenceCounted"></a>ReferenceCounted</h3><p>io.netty.util.ReferenceCounted</p>
<blockquote>
<p>io.netty.util<br>public interface ReferenceCounted<br>A reference-counted object that requires explicit deallocation.<br>When a new ReferenceCounted is instantiated, it starts with the reference count of 1. retain() increases the reference count, and release() decreases the reference count. If the reference count is decreased to 0, the object will be deallocated explicitly, and accessing the deallocated object will usually result in an access violation.<br>If an object that implements ReferenceCounted is a container of other objects that implement ReferenceCounted, the contained objects will also be released via release() when the container&#x2019;s reference count becomes 0.</p>
</blockquote>
<h2 id="ctx-channel-write-&#x548C;ctx-write-&#x7684;&#x533A;&#x522B;"><a href="#ctx-channel-write-&#x548C;ctx-write-&#x7684;&#x533A;&#x522B;" class="headerlink" title="ctx.channel().write()&#x548C;ctx.write()&#x7684;&#x533A;&#x522B;"></a>ctx.channel().write()&#x548C;ctx.write()&#x7684;&#x533A;&#x522B;</h2><p>&#x5728; Netty &#x4E2D;&#x6709;&#x4E24;&#x79CD;&#x53D1;&#x6D88;&#x606F;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5199;&#x5230; Channel &#x4E2D;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5199;&#x5230;&#x4E0E; ChannelHandler &#x6240;&#x5173;&#x8054;&#x7684;&#x90A3;&#x4E2A; ChannelHandlerContext &#x4E2D;&#xFF0C;&#x5BF9;&#x4E8E; <code>ctx.channel().write()</code> &#x65B9;&#x5F0F;&#x6765;&#x8BF4;&#xFF0C;&#x6D88;&#x606F;&#x4F1A;&#x4ECE; ChannelPipeline &#x7684;&#x672B;&#x5C3E;&#x5F00;&#x59CB;&#x6D41;&#x52A8;&#xFF0C;&#x5BF9;&#x4E8E; <code>ctx.write()</code> &#x6765;&#x8BF4;&#xFF0C;&#x6D88;&#x606F;&#x5C06;&#x4ECE; ChannelPipeline &#x4E2D;&#x7684;&#x4E0B;&#x4E00;&#x4E2A; ChannelHandler &#x5F00;&#x59CB;&#x6D41;&#x52A8;</p>
<p>&#x8FD9;&#x7BC7;&#x535A;&#x5BA2;&#x4E2A;&#x89E3;&#x91CA;&#x4E86;</p>
<p><a href="https://blog.csdn.net/FishSeeker/article/details/78447684" target="_blank" rel="noopener">https://blog.csdn.net/FishSeeker/article/details/78447684</a></p>
<p>&#x7ED3;&#x8BBA;&#xFF1A;</p>
<ol>
<li>ChannelHandlerContext &#x4E0E; ChannelHandler &#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;&#x7ED1;&#x5B9A;&#x5173;&#x7CFB;&#x662F;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x53D1;&#x751F;&#x6539;&#x53D8;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x7F13;&#x5B58;&#x65F6;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x95EE;&#x9898;&#x7684;</li>
<li>&#x5BF9;&#x4E8E;&#x4E0E; Channel &#x7684;&#x540C;&#x540D;&#x65B9;&#x6CD5;&#x6765;&#x8BF4;&#xFF0C; ChannelHandlerContext &#x7684;&#x65B9;&#x6CD5;&#x5C06;&#x4F1A;&#x4EA7;&#x751F;&#x66F4;&#x77ED;&#x7684;&#x4E8B;&#x4EF6;&#x6D41;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x56E0;&#x8BE5;&#x5728;&#x53EF;&#x80FD;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x6765;&#x63D0;&#x5347;&#x6027;&#x80FD;</li>
</ol>
<h2 id="Java-NIO"><a href="#Java-NIO" class="headerlink" title="Java NIO"></a>Java NIO</h2><h3 id="NIO-&#x603B;&#x7ED3;"><a href="#NIO-&#x603B;&#x7ED3;" class="headerlink" title="NIO &#x603B;&#x7ED3;"></a>NIO &#x603B;&#x7ED3;</h3><p>&#x4F7F;&#x7528; NIO &#x8FDB;&#x884C;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;&#x6240;&#x6D89;&#x53CA;&#x7684;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>&#x4ECE; FileInputStream &#x5BF9;&#x8C61;&#x83B7;&#x53D6;&#x5230; Channel &#x5BF9;&#x8C61;</li>
<li>&#x521B;&#x5EFA; Buffer</li>
<li>&#x5C06;&#x6570;&#x636E;&#x4ECE; Channel &#x4E2D;&#x8BFB;&#x53D6;&#x5230;Buffer&#x4E2D;</li>
</ol>
<p><img src="/2019/01/19/Netty &#x6E90;&#x7801;&#x5206;&#x6790;&#xFF08;&#x56DB;&#xFF09;/Netty &#x6E90;&#x7801;&#x5206;&#x6790;&#xFF08;&#x56DB;&#xFF09;\20190118000012.png" alt="20190118000012"></p>
<p>0 &lt;= mark &lt;= position &lt;= limit &lt;= capacity</p>
<p>flip() &#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li>&#x5C06; limit &#x503C;&#x8BBE;&#x7F6E;&#x4E3A;&#x5F53;&#x524D;&#x7684; position</li>
<li>&#x5C06; position &#x8BBE;&#x7F6E; 0</li>
</ol>
<p>clear() &#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li>&#x5C06; limit &#x8BBE;&#x7F6E;&#x4E3A;capacity</li>
<li>&#x5C06; position &#x8BBE;&#x7F6E;&#x4E3A;0</li>
</ol>
<p>compact() &#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li>&#x5C06;&#x6240;&#x6709;&#x672A;&#x8BFB;&#x7684;&#x6570;&#x636E;&#x590D;&#x5236;&#x5230; buffer &#x8D77;&#x59CB;&#x7684;&#x4F4D;&#x7F6E;&#x5904;</li>
<li>&#x5C06; position &#x8BBE;&#x7F6E;&#x4E3A;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x672A;&#x8BFB;&#x5143;&#x7D20;&#x7684;&#x540E;&#x9762;</li>
<li>&#x5C06; limit &#x8BBE;&#x7F6E;&#x4E3A; capacity</li>
<li>&#x73B0;&#x5728;buffer &#x5C31;&#x51C6;&#x5907;&#x597D;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x4F1A;&#x8986;&#x76D6;&#x672A;&#x8BFB;&#x7684;&#x6570;&#x636E;</li>
</ol>
<h3 id="Java-NIO&#x4E2D;&#xFF0C;&#x5173;&#x4E8E;DirectBuffer&#xFF0C;HeapBuffer&#x7684;&#x7591;&#x95EE;&#xFF1F;"><a href="#Java-NIO&#x4E2D;&#xFF0C;&#x5173;&#x4E8E;DirectBuffer&#xFF0C;HeapBuffer&#x7684;&#x7591;&#x95EE;&#xFF1F;" class="headerlink" title="Java NIO&#x4E2D;&#xFF0C;&#x5173;&#x4E8E;DirectBuffer&#xFF0C;HeapBuffer&#x7684;&#x7591;&#x95EE;&#xFF1F;"></a>Java NIO&#x4E2D;&#xFF0C;&#x5173;&#x4E8E;DirectBuffer&#xFF0C;HeapBuffer&#x7684;&#x7591;&#x95EE;&#xFF1F;</h3><blockquote>
<ol>
<li><p>DirectBuffer &#x5C5E;&#x4E8E;&#x5806;&#x5916;&#x5B58;&#xFF0C;&#x90A3;&#x5E94;&#x8BE5;&#x8FD8;&#x662F;&#x5C5E;&#x4E8E;&#x7528;&#x6237;&#x5185;&#x5B58;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5185;&#x6838;&#x5185;&#x5B58;&#xFF1F;</p>
</li>
<li><p>FileChannel &#x7684;read(ByteBuffer dst)&#x51FD;&#x6570;,write(ByteBuffer src)&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;HeapBuffer&#x7C7B;&#x578B;,&#x5219;&#x4F1A;&#x4E34;&#x65F6;&#x7533;&#x8BF7;&#x4E00;&#x5757;DirectBuffer,&#x8FDB;&#x884C;&#x6570;&#x636E;&#x62F7;&#x8D1D;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x4F20;&#x8F93;&#xFF0C;&#x8FD9;&#x662F;&#x51FA;&#x4E8E;&#x4EC0;&#x4E48;&#x539F;&#x56E0;&#xFF1F;</p>
</li>
</ol>
</blockquote>
<p><strong>&#x7B54;&#x6848;&#xFF1A;</strong> <a href="https://www.zhihu.com/question/57374068/answer/152691891" target="_blank" rel="noopener">https://www.zhihu.com/question/57374068/answer/152691891</a></p>
<p>Java NIO&#x4E2D;&#x7684;direct buffer&#xFF08;&#x4E3B;&#x8981;&#x662F;DirectByteBuffer&#xFF09;&#x5176;&#x5B9E;&#x662F;&#x5206;&#x4E24;&#x90E8;&#x5206;&#x7684;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">      Java        |      native</span><br><span class="line">                  |</span><br><span class="line">DirectByteBuffer  |     malloc&apos;d</span><br><span class="line">[    address   ] -+-&gt; [   data    ]</span><br><span class="line">                  |</span><br></pre></td></tr></table></figure>
<p>&#x5176;&#x4E2D; DirectByteBuffer &#x81EA;&#x8EAB;&#x662F;&#x4E00;&#x4E2A;Java&#x5BF9;&#x8C61;&#xFF0C;&#x5728;Java&#x5806;&#x4E2D;&#xFF1B;&#x800C;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4E2D;&#x6709;&#x4E2A;long&#x7C7B;&#x578B;&#x5B57;&#x6BB5;address&#xFF0C;&#x8BB0;&#x5F55;&#x7740;&#x4E00;&#x5757;&#x8C03;&#x7528; malloc() &#x7533;&#x8BF7;&#x5230;&#x7684;native memory&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x56DE;&#x5230;&#x9898;&#x4E3B;&#x7684;&#x95EE;&#x9898;&#xFF1A;</p>
<blockquote>
<p>\1. DirectBuffer &#x5C5E;&#x4E8E;&#x5806;&#x5916;&#x5B58;&#xFF0C;&#x90A3;&#x5E94;&#x8BE5;&#x8FD8;&#x662F;&#x5C5E;&#x4E8E;&#x7528;&#x6237;&#x5185;&#x5B58;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5185;&#x6838;&#x5185;&#x5B58;&#xFF1F;</p>
</blockquote>
<p>DirectByteBuffer &#x81EA;&#x8EAB;&#x662F;&#xFF08;Java&#xFF09;&#x5806;&#x5185;&#x7684;&#xFF0C;&#x5B83;&#x80CC;&#x540E;&#x771F;&#x6B63;&#x627F;&#x8F7D;&#x6570;&#x636E;&#x7684;buffer&#x662F;&#x5728;&#xFF08;Java&#xFF09;&#x5806;&#x5916;&#x2014;&#x2014;native memory&#x4E2D;&#x7684;&#x3002;&#x8FD9;&#x662F; malloc() &#x5206;&#x914D;&#x51FA;&#x6765;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x662F;&#x7528;&#x6237;&#x6001;&#x7684;&#x3002;</p>
<blockquote>
<p>\2. FileChannel &#x7684;read(ByteBuffer dst)&#x51FD;&#x6570;,write(ByteBuffer src)&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;HeapBuffer&#x7C7B;&#x578B;,&#x5219;&#x4F1A;&#x4E34;&#x65F6;&#x7533;&#x8BF7;&#x4E00;&#x5757;DirectBuffer,&#x8FDB;&#x884C;&#x6570;&#x636E;&#x62F7;&#x8D1D;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x4F20;&#x8F93;&#xFF0C;&#x8FD9;&#x662F;&#x51FA;&#x4E8E;&#x4EC0;&#x4E48;&#x539F;&#x56E0;&#xFF1F;</p>
</blockquote>
<p>&#x9898;&#x4E3B;&#x770B;&#x7684;&#x662F;OpenJDK&#x7684; sun.nio.ch.IOUtil.write(FileDescriptor fd, ByteBuffer src, long position, NativeDispatcher nd) &#x7684;&#x5B9E;&#x73B0;&#x5BF9;&#x4E0D;&#x5BF9;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">static int write(FileDescriptor fd, ByteBuffer src, long position,</span><br><span class="line">                 NativeDispatcher nd)</span><br><span class="line">    throws IOException</span><br><span class="line">{</span><br><span class="line">    if (src instanceof DirectBuffer)</span><br><span class="line">        return writeFromNativeBuffer(fd, src, position, nd);</span><br><span class="line"></span><br><span class="line">    // Substitute a native buffer</span><br><span class="line">    int pos = src.position();</span><br><span class="line">    int lim = src.limit();</span><br><span class="line">    assert (pos &lt;= lim);</span><br><span class="line">    int rem = (pos &lt;= lim ? lim - pos : 0);</span><br><span class="line">    ByteBuffer bb = Util.getTemporaryDirectBuffer(rem);</span><br><span class="line">    try {</span><br><span class="line">        bb.put(src);</span><br><span class="line">        bb.flip();</span><br><span class="line">        // Do not update src until we see how many bytes were written</span><br><span class="line">        src.position(pos);</span><br><span class="line"></span><br><span class="line">        int n = writeFromNativeBuffer(fd, bb, position, nd);</span><br><span class="line">        if (n &gt; 0) {</span><br><span class="line">            // now update src</span><br><span class="line">            src.position(pos + n);</span><br><span class="line">        }</span><br><span class="line">        return n;</span><br><span class="line">    } finally {</span><br><span class="line">        Util.offerFirstTemporaryDirectBuffer(bb);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x662F;&#x5728;&#x8FC1;&#x5C31;OpenJDK&#x91CC;&#x7684;HotSpot VM&#x7684;&#x4E00;&#x70B9;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;&#x3002;</p>
<p>HotSpot VM&#x91CC;&#x7684;GC&#x9664;&#x4E86;CMS&#x4E4B;&#x5916;&#x90FD;&#x662F;&#x8981;&#x79FB;&#x52A8;&#x5BF9;&#x8C61;&#x7684;&#xFF0C;&#x662F;&#x6240;&#x8C13;&#x201C;compacting GC&#x201D;&#x3002;</p>
<p>&#x5982;&#x679C;&#x8981;&#x628A;&#x4E00;&#x4E2A;Java&#x91CC;&#x7684; byte[] &#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x4F20;&#x7ED9;native&#x4EE3;&#x7801;&#xFF0C;&#x8BA9;native&#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x6570;&#x7EC4;&#x7684;&#x5185;&#x5BB9;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x5FC5;&#x987B;&#x8981;&#x4FDD;&#x8BC1;native&#x4EE3;&#x7801;&#x5728;&#x8BBF;&#x95EE;&#x7684;&#x65F6;&#x5019;&#x8FD9;&#x4E2A; byte[] &#x5BF9;&#x8C61;&#x4E0D;&#x80FD;&#x88AB;&#x79FB;&#x52A8;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8981;&#x88AB;&#x201C;pin&#x201D;&#xFF08;&#x9489;&#xFF09;&#x4F4F;&#x3002;</p>
<p>&#x53EF;&#x60DC;HotSpot VM&#x51FA;&#x4E8E;&#x4E00;&#x4E9B;&#x53D6;&#x820D;&#x800C;&#x51B3;&#x5B9A;&#x4E0D;&#x5B9E;&#x73B0;&#x5355;&#x4E2A;&#x5BF9;&#x8C61;&#x5C42;&#x9762;&#x7684;object pinning&#xFF0C;&#x8981;pin&#x7684;&#x8BDD;&#x5C31;&#x5F97;&#x6682;&#x65F6;&#x7981;&#x7528;GC&#x2014;&#x2014;&#x4E5F;&#x5C31;&#x7B49;&#x4E8E;&#x628A;&#x6574;&#x4E2A;Java&#x5806;&#x90FD;&#x7ED9;pin&#x4F4F;&#x3002;HotSpot VM&#x5BF9;JNI&#x7684;Critical&#x7CFB;API&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x8FD9;&#x7528;&#x8D77;&#x6765;&#x5C31;&#x4E0D;&#x90A3;&#x4E48;&#x987A;&#x624B;&#x3002;</p>
<p>&#x6240;&#x4EE5; Oracle/Sun JDK / OpenJDK &#x7684;&#x8FD9;&#x4E2A;&#x5730;&#x65B9;&#x5C31;&#x7528;&#x4E86;&#x70B9;&#x7ED5;&#x5F2F;&#x7684;&#x505A;&#x6CD5;&#x3002;&#x5B83;&#x5047;&#x8BBE;&#x628A; HeapByteBuffer &#x80CC;&#x540E;&#x7684; byte[] &#x91CC;&#x7684;&#x5185;&#x5BB9;&#x62F7;&#x8D1D;&#x4E00;&#x6B21;&#x662F;&#x4E00;&#x4E2A;&#x65F6;&#x95F4;&#x5F00;&#x9500;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x540C;&#x65F6;&#x5047;&#x8BBE;&#x771F;&#x6B63;&#x7684;I/O&#x53EF;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x6162;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x4E8E;&#x662F;&#x5B83;&#x5C31;&#x5148;&#x628A; HeapByteBuffer &#x80CC;&#x540E;&#x7684; byte[] &#x7684;&#x5185;&#x5BB9;&#x62F7;&#x8D1D;&#x5230;&#x4E00;&#x4E2A; DirectByteBuffer &#x80CC;&#x540E;&#x7684;native memory&#x53BB;&#xFF0C;&#x8FD9;&#x4E2A;&#x62F7;&#x8D1D;&#x4F1A;&#x6D89;&#x53CA; sun.misc.Unsafe.copyMemory() &#x7684;&#x8C03;&#x7528;&#xFF0C;&#x80CC;&#x540E;&#x662F;&#x7C7B;&#x4F3C; memcpy() &#x7684;&#x5B9E;&#x73B0;&#x3002;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x4F1A;&#x5728;&#x6574;&#x4E2A;&#x62F7;&#x8D1D;&#x8FC7;&#x7A0B;&#x4E2D;&#x6682;&#x65F6;&#x4E0D;&#x5141;&#x8BB8;&#x53D1;&#x751F;GC&#x7684;&#xFF0C;&#x867D;&#x7136;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x8DDF;JNI&#x7684;Critical&#x7CFB;API&#x4E0D;&#x592A;&#x4E00;&#x6837;&#x3002;&#xFF08;&#x5177;&#x4F53;&#x6765;&#x8BF4;&#x662F; Unsafe.copyMemory() &#x662F;HotSpot VM&#x7684;&#x4E00;&#x4E2A;intrinsic&#x65B9;&#x6CD5;&#xFF0C;&#x4E2D;&#x95F4;&#x6CA1;&#x6709;safepoint&#x6240;&#x4EE5;GC&#x65E0;&#x6CD5;&#x53D1;&#x751F;&#xFF09;&#x3002;</p>
<p>&#x7136;&#x540E;&#x6570;&#x636E;&#x88AB;&#x62F7;&#x8D1D;&#x5230;native memory&#x4E4B;&#x540E;&#x5C31;&#x597D;&#x529E;&#x4E86;&#xFF0C;&#x5C31;&#x53BB;&#x505A;&#x771F;&#x6B63;&#x7684;I/O&#xFF0C;&#x628A; DirectByteBuffer &#x80CC;&#x540E;&#x7684;native memory&#x5730;&#x5740;&#x4F20;&#x7ED9;&#x771F;&#x6B63;&#x505A;I/O&#x7684;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x8FB9;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x518D;&#x53BB;&#x8BBF;&#x95EE;Java&#x5BF9;&#x8C61;&#x53BB;&#x8BFB;&#x5199;&#x8981;&#x505A;I/O&#x7684;&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<h2 id="ByteBuf"><a href="#ByteBuf" class="headerlink" title="ByteBuf"></a>ByteBuf</h2><p>&#x6587;&#x6863;&#xFF1A;<a href="https://netty.io/4.1/api/index.html" target="_blank" rel="noopener">https://netty.io/4.1/api/index.html</a></p>
<p>&#x6211;&#x4EEC;&#x770B;&#x7B2C;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteBufTest01</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="keyword">final</span> ByteBuf buffer = Unpooled.buffer(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, index = <span class="number">120</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            buffer.writeByte(index + i);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            System.out.println(buffer.getByte(i));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8F93;&#x51FA;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">-128</span><br><span class="line">-127</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x6587;&#x6863;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the specified byte at the current {<span class="doctag">@code</span> writerIndex}</span></span><br><span class="line"><span class="comment"> * and increases the {<span class="doctag">@code</span> writerIndex} by {<span class="doctag">@code</span> 1} in this buffer.</span></span><br><span class="line"><span class="comment"> * The 24 high-order bits of the specified value are ignored.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IndexOutOfBoundsException</span></span><br><span class="line"><span class="comment"> *         if {<span class="doctag">@code</span> this.writableBytes} is less than {<span class="doctag">@code</span> 1}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeByte</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br></pre></td></tr></table></figure>
<p>&#x867D;&#x7136;&#x4F20;&#x5165;&#x7684;&#x4E00;&#x4E2A; int &#x503C;&#xFF0C;&#x53EF;&#x662F;&#x5B83;&#x4F1A;&#x4E22;&#x5F03;&#x9AD8;&#x4F4D;&#x7684; 24 bit&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053; int &#x662F; 4 &#x5B57;&#x8282;&#xFF08;32 bit&#xFF09;&#xFF0C;&#x4E22;&#x5F03; 3 &#x5B57;&#x8282; &#xFF08;24 bit&#xFF09;&#xFF0C;&#x5C31;&#x4FDD;&#x7559;&#x5230; 1 &#x5B57;&#x8282;&#xFF08;8 bit&#xFF09;</p>
<p>&#x6211;&#x4EEC;&#x8981;&#x770B;&#x4E0B;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteBufTest02</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        ByteBuf byteBuf = Unpooled.copiedBuffer(<span class="string">&quot;hello world&quot;</span>, Charset.forName(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x5806;&#x7F13;&#x5B58;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x5806;&#x7F13;&#x5B58;&#xFF0C;&#x8FD4;&#x56DE;true</span></span><br><span class="line">        <span class="keyword">if</span> (byteBuf.hasArray()) {</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = byteBuf.array();</span><br><span class="line">            System.out.println(<span class="keyword">new</span> String(bytes, Charset.forName(<span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">            System.out.println(byteBuf);</span><br><span class="line"></span><br><span class="line">            System.out.println(byteBuf.arrayOffset());  <span class="comment">// &#x53EF;&#x8BFB;&#x5B57;&#x8282;&#x7B2C;&#x4E00;&#x504F;&#x79FB;&#x91CF;</span></span><br><span class="line">            System.out.println(byteBuf.readerIndex());</span><br><span class="line">            System.out.println(byteBuf.writerIndex());</span><br><span class="line">            System.out.println(byteBuf.capacity());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8F93;&#x51FA;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hello world                      </span><br><span class="line">UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf(ridx: 0, widx: 11, cap: 33)</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">11</span><br><span class="line">33</span><br></pre></td></tr></table></figure>
<p>ridx &#x8868;&#x793A;&#x8BFB;&#x7684; index&#xFF0C;widx &#x8868;&#x793A;&#x5199;&#x7684; index</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x590D;&#x5408; Buffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteBufTest03</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// &#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x590D;&#x5408; buffer</span></span><br><span class="line">        CompositeByteBuf compositeByteBuf = Unpooled.compositeBuffer();</span><br><span class="line"></span><br><span class="line">        ByteBuf heapBuf = Unpooled.buffer(<span class="number">10</span>);</span><br><span class="line">        ByteBuf directBuf = Unpooled.directBuffer(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        compositeByteBuf.addComponent(heapBuf);</span><br><span class="line">        compositeByteBuf.addComponent(directBuf);</span><br><span class="line"></span><br><span class="line">        compositeByteBuf.forEach(System.out::println);</span><br><span class="line">        <span class="comment">// &#x8F93;&#x51FA;</span></span><br><span class="line">        <span class="comment">// UnpooledSlicedByteBuf(ridx: 0, widx: 0, cap: 0/0, unwrapped: UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf(ridx: 0, widx: 0, cap: 10))</span></span><br><span class="line">        <span class="comment">// UnpooledSlicedByteBuf(ridx: 0, widx: 0, cap: 0/0, unwrapped: UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf(ridx: 0, widx: 0, cap: 8))</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="Netty-&#x63D0;&#x4F9B;&#x7684;-3-&#x79CD;&#x7F13;&#x51B2;&#x533A;"><a href="#Netty-&#x63D0;&#x4F9B;&#x7684;-3-&#x79CD;&#x7F13;&#x51B2;&#x533A;" class="headerlink" title="Netty &#x63D0;&#x4F9B;&#x7684; 3 &#x79CD;&#x7F13;&#x51B2;&#x533A;"></a>Netty &#x63D0;&#x4F9B;&#x7684; 3 &#x79CD;&#x7F13;&#x51B2;&#x533A;</h3><p><strong>heap buffer&#xFF08;&#x5806;&#x7F13;&#x51B2;&#x533A;&#xFF09;&#xFF1A;</strong></p>
<p>&#x8FD9;&#x662F;&#x6700;&#x5E38;&#x89C1;&#x7684;&#x7C7B;&#x578B;&#xFF0C;ByteBuf &#x5C06;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5230; JVM &#x7684;&#x5806;&#x7A7A;&#x95F4;&#x4E2D;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x5B9E;&#x9645;&#x7684;&#x6570;&#x636E;&#x653E;&#x5230; byte &#x6570;&#x7EC4;&#x4E2D;&#x6765;&#x5B9E;&#x73B0;&#x7684;</p>
<p>&#x4F18;&#x70B9;&#xFF1A;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x662F;&#x5B58;&#x50A8;&#x5728; JVM &#x7684;&#x5806;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x5FEB;&#x901F;&#x7684;&#x521B;&#x5EFA;&#x548C;&#x5FEB;&#x901F;&#x7684;&#x91CA;&#x653E;&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x63D0;&#x4F9B;&#x4E86; &#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x5185;&#x90E8;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x7684;&#x65B9;&#x6CD5;</p>
<p>&#x7F3A;&#x70B9;&#xFF1A;&#x6BCF;&#x6B21;&#x8BFB;&#x5199;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x5148;&#x5C06;&#x6570;&#x636E;&#x590D;&#x5236;&#x5230;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x4E2D;&#x518D;&#x8FDB;&#x884C;&#x7F51;&#x7EDC;&#x4F20;&#x8F93;</p>
<p><strong>direct buffer&#xFF08;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;&#xFF09;&#xFF1A;</strong></p>
<p>&#x5728;&#x5806;&#x4E4B;&#x5916;&#x76F4;&#x63A5;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;&#x5E76;&#x4E0D;&#x4F1A;&#x5360;&#x7528;&#x5806;&#x7684;&#x5BB9;&#x91CF;&#x7A7A;&#x95F4;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x662F;&#x6709;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5728;&#x672C;&#x5730;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x7684;&#x6570;&#x636E;&#x5206;&#x914D;</p>
<p>&#x4F18;&#x70B9;&#xFF1A;&#x5728;&#x4F7F;&#x7528; Socket &#x8FDB;&#x884C;&#x6570;&#x636E;&#x4F20;&#x8F93;&#x65F6;&#xFF0C;&#x6027;&#x80FD;&#x975E;&#x5E38;&#x597D;&#xFF0C;&#x56E0;&#x4E3A;&#x6570;&#x636E;&#x76F4;&#x63A5;&#x4F4D;&#x4E8E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x672C;&#x5730;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x9700;&#x8981;&#x4ECE; JVM &#x5C06;&#x6570;&#x636E;&#x590D;&#x5236;&#x5230;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;</p>
<p>&#x7F3A;&#x70B9;&#xFF1A;&#x56E0;&#x4E3A; Direct Buffer &#x662F;&#x76F4;&#x63A5;&#x5728;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x4E0E;&#x91CA;&#x653E;&#x8981;&#x6BD4;&#x5806;&#x7A7A;&#x95F4;&#x66F4;&#x52A0;&#x590D;&#x6742;&#xFF0C;&#x800C;&#x4E14;&#x901F;&#x5EA6;&#x8981;&#x6162;&#x4E00;&#x4E9B;</p>
<p>Netty &#x901A;&#x8FC7;&#x63D0;&#x4F9B;&#x5185;&#x5B58;&#x6C60;&#x6765;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;&#x5E76;&#x4E0D;&#x652F;&#x6301;&#x901A;&#x8FC7;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x8BBF;&#x95EE;&#x6570;&#x636E;</p>
<p>&#x91CD;&#x70B9;&#xFF1A;&#x5BF9;&#x4E8E;&#x540E;&#x7AEF;&#x7684;&#x4E1A;&#x52A1;&#x6D88;&#x606F;&#x7684;&#x7F16;&#x89E3;&#x7801;&#x6765;&#x8BF4;&#xFF0C;&#x63A8;&#x8350;&#x4F7F;&#x7528; HeapByteBuf&#xFF1B;&#x5BF9;&#x4E8E; I/O &#x901A;&#x4FE1;&#x7684;&#x8BFB;&#x5199;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x6211;&#x4EEC;&#x63A8;&#x8350;&#x4F7F;&#x7528; DirectBytebuf</p>
<p><strong>composite buffer&#xFF08;&#x7B26;&#x5408;&#x7F13;&#x51B2;&#x533A;&#xFF09;&#xFF1A;</strong></p>
<p>&#x590D;&#x5408;&#x7F13;&#x51B2;&#x533A;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5C06;&#x591A;&#x4E2A;&#x7F13;&#x51B2;&#x533A;&#x5B9E;&#x4F8B;&#x7EC4;&#x5408;&#x8D77;&#x6765;&#xFF0C;&#x5E76;&#x5411;&#x5916;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x89C6;&#x56FE;&#x3002;&#x50CF;&#x662F;&#x4E00;&#x4E2A;&#x7F13;&#x51B2;&#x533A;&#x7684; List</p>
<h3 id="JDK-&#x7684;-ByteBuffer-&#x4E0E;-Netty-&#x7684;-ByteBuf-&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x6BD4;&#x5BF9;"><a href="#JDK-&#x7684;-ByteBuffer-&#x4E0E;-Netty-&#x7684;-ByteBuf-&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x6BD4;&#x5BF9;" class="headerlink" title="JDK &#x7684; ByteBuffer &#x4E0E; Netty &#x7684; ByteBuf &#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x6BD4;&#x5BF9;"></a>JDK &#x7684; ByteBuffer &#x4E0E; Netty &#x7684; ByteBuf &#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x6BD4;&#x5BF9;</h3><ol>
<li>Netty &#x7684; ByteBuf &#x91C7;&#x7528;&#x4E86;&#x8BFB;&#x5199;&#x5206;&#x79BB;&#x7684;&#x7B56;&#x7565;&#xFF08;readerIndex &#x548C; writeerIndex&#xFF09;&#xFF0C;&#x4E00;&#x4E2A;&#x521D;&#x59CB;&#x5316;&#xFF08;&#x91CC;&#x9762;&#x5C1A;&#x672A;&#x6709;&#x4EFB;&#x4F55;&#x6570;&#x636E;&#xFF09;&#x7684; ByteBuf &#x7684; readerIndex &#x4E0E; writerIndex &#x7684;&#x503C;&#x90FD;&#x4E3A;0</li>
<li>&#x5F53;&#x6570;&#x7D22;&#x5F15;&#x4E0E;&#x5199;&#x7D22;&#x5F15;&#x5904;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x8BFB;&#x53D6;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x629B;&#x51FA; IndexOutOfBoundsException</li>
<li>&#x5BF9;&#x4E8E;ByteBuf &#x7684;&#x4EFB;&#x4F55;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x90FD;&#x4F1A;&#x5206;&#x522B;&#x5355;&#x72EC;&#x7EF4;&#x62A4;&#x8BFB;&#x7D22;&#x5F15;&#x548C;&#x5199;&#x7D22;&#x5F15;&#xFF0C;MaxCapacity &#x6700;&#x5927;&#x7684;&#x5BB9;&#x91CF;&#x9ED8;&#x8BA4;&#x4E3A;Integer.MAX_VALUE</li>
</ol>
<p><img src="/2019/01/19/Netty &#x6E90;&#x7801;&#x5206;&#x6790;&#xFF08;&#x56DB;&#xFF09;/Netty &#x6E90;&#x7801;&#x5206;&#x6790;&#xFF08;&#x56DB;&#xFF09;\ByteBuf internal segmentation.jpg" alt="ByteBuf internal segmentation"></p>
<p>JDK &#x7684; ByteBuffer&#x7684;&#x7F3A;&#x70B9;&#xFF1A;</p>
<ol>
<li>final byte[] hb; &#x8FD9;&#x662F;JDK&#x7684;ByteBuffer&#x5BF9;&#x8C61;&#x4E2D;&#x7528;&#x4E8E;&#x50A8;&#x5B58;&#x7684;&#x5BF9;&#x8C61;&#x58F0;&#x660E;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5176;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x5E03;&#x5C14;&#x58F0;&#x660E;&#x4E3A;final&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x957F;&#x5EA6;&#x662F;&#x56FA;&#x5B9A;&#x4E0D;&#x53D8;&#x7684;&#xFF0C;&#x4E00;&#x65E6;&#x5206;&#x914D;&#x597D;&#x540E;&#x5C31;&#x4E0D;&#x80FD;&#x52A8;&#x6001;&#x6269;&#x5BB9;&#x4E0E;&#x6536;&#x7F29;&#xFF0C;&#x800C;&#x4E14;&#x5F53;&#x50A8;&#x5B58;&#x7684;&#x6570;&#x636E;&#x5B57;&#x8282;&#x5F88;&#x5927;&#x65F6;&#x5C31;&#x5F88;&#x6709;&#x53EF;&#x80FD;&#x51FA;&#x73B0;IndexOutOfBoundsException&#xFF0C;&#x5982;&#x679C;&#x8981;&#x9884;&#x9632;&#x7740;&#x4E2A;&#x5F02;&#x5E38;&#xFF0C;&#x90A3;&#x5C31;&#x9700;&#x8981;&#x518D;&#x50A8;&#x5B58;&#x4E4B;&#x524D;&#x5B8C;&#x5168;&#x786E;&#x5B9A;&#x597D;&#x5F85;&#x50A8;&#x5B58;&#x7684;&#x5B57;&#x8282;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x5982;&#x679C;ByteBuffer&#x7684;&#x7A7A;&#x95F4;&#x4E0D;&#x8DB3;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x6709;&#x4E00;&#x79CD;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x521B;&#x5EFA;&#x65B0;&#x7684;ByteBuffer&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x5C06;&#x4E4B;&#x524D;&#x7684;ByteBuffer&#x4E2D;&#x7684;&#x6570;&#x636E;&#x590D;&#x5236;&#x8FC7;&#x53BB;&#xFF0C;&#x8FD9;&#x4E00;&#x5207;&#x64CD;&#x4F5C;&#x90FD;&#x9700;&#x8981;&#x7531;&#x5F00;&#x53D1;&#x8005;&#x81EA;&#x5DF1;&#x6765;&#x624B;&#x52A8;&#x5B8C;&#x6210;&#x7684;</li>
<li>ByteBuffer &#x53EA;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;position &#x6307;&#x9488;&#x6765;&#x6807;&#x8BC6;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x5728;&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#x5207;&#x6362;&#x65F6;&#x5C31;&#x9700;&#x8981;&#x8C03;&#x7528;flip&#x65B9;&#x6CD5;&#x6216;&#x5219;&#x662F;rewind &#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x7528;&#x5F88;&#x4E0D;&#x65B9;&#x4FBF;</li>
</ol>
<p>Netty &#x7684; ByteBuf &#x7684;&#x4F18;&#x70B9;&#xFF1A;</p>
<ol>
<li>&#x50A8;&#x5B58;&#x5B57;&#x8282;&#x7684;&#x6570;&#x7EC4;&#x662F;&#x52A8;&#x6001;&#x7684;&#xFF0C;&#x5176;&#x6700;&#x5927;&#x503C;&#x9ED8;&#x8BA4;&#x662F;Integer.MAX_VALUE&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x52A8;&#x6001;&#x6027;&#x662F;&#x4F53;&#x73B0;&#x5728;write&#x65B9;&#x6CD5;&#x4E2D;&#x7684;&#xFF0C;write&#x65B9;&#x6CD5;&#x6267;&#x884C;&#x4F1A;&#x5224;&#x65AD;buffer&#x5BB9;&#x91CF;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x8DB3;&#x5219;&#x4F1A;&#x81EA;&#x52A8;&#x6269;&#x5BB9;</li>
<li>ByteBuf&#x7684;&#x8BFB;&#x5199;&#x7D22;&#x5F15;&#x662F;&#x5B8C;&#x6210;&#x5206;&#x5F00;&#x7684;&#xFF0C;&#x4F7F;&#x7528;&#x8D77;&#x6765;&#x5F88;&#x65B9;&#x4FBF;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.netty.buffer.AbstractByteBuf#writeByte</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ByteBuf <span class="title">writeByte</span><span class="params">(<span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">       ensureWritable0(<span class="number">1</span>);   <span class="comment">// &#x4F1A;&#x5148;&#x5224;&#x65AD;&#x662F;&#x5426;&#x591F;&#x5199;&#x5165;&#x4E00;&#x4E2A;&#x5B57;&#x8282;</span></span><br><span class="line">       _setByte(writerIndex++, value);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line"><span class="comment">// io.netty.buffer.AbstractByteBuf#ensureWritable0</span></span><br><span class="line"><span class="comment">// &#x4F1A;&#x81EA;&#x52A8;&#x6269;&#x5BB9;</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">ensureWritable0</span><span class="params">(<span class="keyword">int</span> minWritableBytes)</span> </span>{</span><br><span class="line">       ensureAccessible();</span><br><span class="line">       <span class="keyword">if</span> (minWritableBytes &lt;= writableBytes()) {</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (minWritableBytes &gt; maxCapacity - writerIndex) {</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</span><br><span class="line">                   <span class="string">&quot;writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s&quot;</span>,</span><br><span class="line">                   writerIndex, minWritableBytes, maxCapacity, <span class="keyword">this</span>));</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Normalize the current capacity to the power of 2.</span></span><br><span class="line">       <span class="keyword">int</span> newCapacity = alloc().calculateNewCapacity(writerIndex + minWritableBytes, maxCapacity);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Adjust to the new capacity.</span></span><br><span class="line">       capacity(newCapacity);</span><br><span class="line">   }</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    


<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
  
</div>
<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2019/01/19/Netty 源码分析（四）/">Netty 源码分析（四）</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 cuzz 的个人博客">cuzz</a></p>
  <p><span>发布时间:</span>2019年01月19日 - 00:01</p>
  <p><span>最后更新:</span>2019年07月16日 - 19:07</p>
  <p><span>原始链接:</span><a href="/2019/01/19/Netty 源码分析（四）/" title="Netty 源码分析（四）">http://blog.cuzz.site/2019/01/19/Netty 源码分析（四）/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://blog.cuzz.site/2019/01/19/Netty 源码分析（四）/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>

      
</div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>请博主吃包辣条</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="cuzz 微信支付">
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/源码/" rel="tag"><i class="fa fa-tag"></i> 源码</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/16/Netty 源码分析（三）/" rel="next" title="Netty 源码分析（三）">
                <i class="fa fa-chevron-left"></i> Netty 源码分析（三）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/22/Netty 源码分析（五）/" rel="prev" title="Netty 源码分析（五）">
                Netty 源码分析（五） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2154292" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
	<div id="gitalk-container"></div>
	
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="cuzz">
            
              <p class="site-author-name" itemprop="name">cuzz</p>
              <p class="site-description motion-element" itemprop="description">爱分享，爱技术，爱生活。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/cuzz1" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/7106f93fb795" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-book"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.bing.com" title="必应" target="_blank">必应</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ChannelPromise"><span class="nav-number">1.</span> <span class="nav-text">ChannelPromise</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Promise"><span class="nav-number">1.1.</span> <span class="nav-text">Promise</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ChannelInboundHandlerAdapter"><span class="nav-number">2.</span> <span class="nav-text">ChannelInboundHandlerAdapter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ChannelInboundHandler"><span class="nav-number">2.1.</span> <span class="nav-text">ChannelInboundHandler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SimpleChannelInboundHandler"><span class="nav-number">3.</span> <span class="nav-text">SimpleChannelInboundHandler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ReferenceCounted"><span class="nav-number">3.1.</span> <span class="nav-text">ReferenceCounted</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ctx-channel-write-和ctx-write-的区别"><span class="nav-number">4.</span> <span class="nav-text">ctx.channel().write()和ctx.write()的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-NIO"><span class="nav-number">5.</span> <span class="nav-text">Java NIO</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NIO-总结"><span class="nav-number">5.1.</span> <span class="nav-text">NIO 总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-NIO中，关于DirectBuffer，HeapBuffer的疑问？"><span class="nav-number">5.2.</span> <span class="nav-text">Java NIO中，关于DirectBuffer，HeapBuffer的疑问？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ByteBuf"><span class="nav-number">6.</span> <span class="nav-text">ByteBuf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Netty-提供的-3-种缓冲区"><span class="nav-number">6.1.</span> <span class="nav-text">Netty 提供的 3 种缓冲区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK-的-ByteBuffer-与-Netty-的-ByteBuf-之间的差异比对"><span class="nav-number">6.2.</span> <span class="nav-text">JDK 的 ByteBuffer 与 Netty 的 ByteBuf 之间的差异比对</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cuzz</span>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共139.5k字</span>
</div>
  
</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   
   <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'e829281603f9115c572d',
          clientSecret: '246dae10dfb1b363805ab98902dc93539c355bb3',
          repo: 'cuzz1.github.io',
          owner: 'cuzz1',
          admin: ['cuzz1'],
          id: decodeURI(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "default";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
<div id="hexo-helper-live2d">
  <canvas id="live2dcanvas" width="150" height="300"></canvas>
</div>
<style>
  #live2dcanvas{
    position: fixed;
    width: 150px;
    height: 300px;
    opacity:0.7;
    right: -30px;
    z-index: 999;
    pointer-events: none;
    bottom: 10px;
  }
</style>
<script type="text/javascript" src="/live2d/device.min.js"></script>
<script type="text/javascript">
const loadScript = function loadScript(c,b){var a=document.createElement("script");a.type="text/javascript";"undefined"!=typeof b&&(a.readyState?a.onreadystatechange=function(){if("loaded"==a.readyState||"complete"==a.readyState)a.onreadystatechange=null,b()}:a.onload=function(){b()});a.src=c;document.body.appendChild(a)};
(function(){
  if((typeof(device) != 'undefined') && (device.mobile())){
    var trElement = document.getElementById('hexo-helper-live2d');
    trElement.parentNode.removeChild(trElement);
    return;
  }else
    if (typeof(device) === 'undefined') console.error('Cannot find current-device script.');
  loadScript("/live2d/script.js", function(){loadlive2d("live2dcanvas", "/live2d/assets/tororo.model.json", 0.5);});
})();
</script>

</body>
</html>
<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/src/love.js"></script>
