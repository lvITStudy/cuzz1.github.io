<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">

<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="源码,">





  <link rel="alternate" href="/atom.xml" title="cuzz's blog" type="application/atom+xml">






<meta name="description" content="&amp;#x7248;&amp;#x672C; 4.1.15    &amp;#x5B98;&amp;#x7F51;&amp;#xFF1A;https://netty.io/  Netty is an asynchronous event-driven network application framework  for rapid development of maintainable high performance protoc">
<meta name="keywords" content="源码">
<meta property="og:type" content="article">
<meta property="og:title" content="Netty 源码分析（五）">
<meta property="og:url" content="http://blog.cuzz.site/2019/01/22/Netty 源码分析（五）/index.html">
<meta property="og:site_name" content="cuzz&#39;s blog">
<meta property="og:description" content="&amp;#x7248;&amp;#x672C; 4.1.15    &amp;#x5B98;&amp;#x7F51;&amp;#xFF1A;https://netty.io/  Netty is an asynchronous event-driven network application framework  for rapid development of maintainable high performance protoc">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://blog.cuzz.site/2019/01/22/Netty%20源码分析（五）/Netty%20源码分析（五）/timg.jpg">
<meta property="og:updated_time" content="2019-07-16T11:43:31.297Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Netty 源码分析（五）">
<meta name="twitter:description" content="&amp;#x7248;&amp;#x672C; 4.1.15    &amp;#x5B98;&amp;#x7F51;&amp;#xFF1A;https://netty.io/  Netty is an asynchronous event-driven network application framework  for rapid development of maintainable high performance protoc">
<meta name="twitter:image" content="http://blog.cuzz.site/2019/01/22/Netty%20源码分析（五）/Netty%20源码分析（五）/timg.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.cuzz.site/2019/01/22/Netty 源码分析（五）/">






  <title>Netty 源码分析（五） | cuzz's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?415372bd35fec36f7558dd96b48ec03f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

<a href="https://github.com/cuzz1" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">cuzz's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">填坑之路(Github托管)</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.cuzz.site/2019/01/22/Netty 源码分析（五）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cuzz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cuzz's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Netty 源码分析（五）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-22T17:29:07+08:00">
                2019-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,681
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  19
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&#x7248;&#x672C; 4.1.15   </p>
<p>&#x5B98;&#x7F51;&#xFF1A;<a href="https://netty.io/" target="_blank" rel="noopener">https://netty.io/</a></p>
<blockquote>
<p>Netty is <em>an asynchronous event-driven network application framework</em>  for rapid development of maintainable high performance protocol servers &amp; clients. </p>
</blockquote>
<a id="more"></a>
<h2 id="ReferenceCounted"><a href="#ReferenceCounted" class="headerlink" title="ReferenceCounted"></a>ReferenceCounted</h2><p>io.netty.util.ReferenceCounted</p>
<p>&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6587;&#x6863;</p>
<blockquote>
<p>public interface ReferenceCounted<br>A reference-counted object that requires explicit deallocation.<br>When a new ReferenceCounted is instantiated, it starts with the reference count of 1. retain() increases the reference count, and release() decreases the reference count. If the reference count is decreased to 0, the object will be deallocated explicitly, and accessing the deallocated object will usually result in an access violation.<br>If an object that implements ReferenceCounted is a container of other objects that implement ReferenceCounted, the contained objects will also be released via release() when the container&#x2019;s reference count becomes 0.</p>
</blockquote>
<p>&#x6211;&#x4EEC;&#x770B;&#x770B;&#x5176;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReferenceCounted</span> </span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the reference count of this object.  If {<span class="doctag">@code</span> 0}, it means this object has been deallocated.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">refCnt</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Increases the reference count by {<span class="doctag">@code</span> 1}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ReferenceCounted <span class="title">retain</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Increases the reference count by the specified {<span class="doctag">@code</span> increment}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ReferenceCounted <span class="title">retain</span><span class="params">(<span class="keyword">int</span> increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Records the current access location of this object for debugging purposes.</span></span><br><span class="line"><span class="comment">     * If this object is determined to be leaked, the information recorded by this operation will be provided to you</span></span><br><span class="line"><span class="comment">     * via {<span class="doctag">@link</span> ResourceLeakDetector}.  This method is a shortcut to {<span class="doctag">@link</span> #touch(Object) touch(null)}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ReferenceCounted <span class="title">touch</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Records the current access location of this object with an additional arbitrary information for debugging</span></span><br><span class="line"><span class="comment">     * purposes.  If this object is determined to be leaked, the information recorded by this operation will be</span></span><br><span class="line"><span class="comment">     * provided to you via {<span class="doctag">@link</span> ResourceLeakDetector}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ReferenceCounted <span class="title">touch</span><span class="params">(Object hint)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decreases the reference count by {<span class="doctag">@code</span> 1} and deallocates this object if the reference count reaches at</span></span><br><span class="line"><span class="comment">     * {<span class="doctag">@code</span> 0}.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> {<span class="doctag">@code</span> true} if and only if the reference count became {<span class="doctag">@code</span> 0} and this object has been deallocated</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">release</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decreases the reference count by the specified {<span class="doctag">@code</span> decrement} and deallocates this object if the reference</span></span><br><span class="line"><span class="comment">     * count reaches at {<span class="doctag">@code</span> 0}.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> {<span class="doctag">@code</span> true} if and only if the reference count became {<span class="doctag">@code</span> 0} and this object has been deallocated</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> decrement)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="AbstractReferenceCountedByteBuf"><a href="#AbstractReferenceCountedByteBuf" class="headerlink" title="AbstractReferenceCountedByteBuf"></a>AbstractReferenceCountedByteBuf</h3><p>io.netty.buffer.AbstractReferenceCountedByteBuf</p>
<p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E24;&#x4E2A;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;retain() &#x548C; release() &#x65B9;&#x6CD5;</p>
<h4 id="retain"><a href="#retain" class="headerlink" title="retain()"></a>retain()</h4><p>io.netty.buffer.AbstractReferenceCountedByteBuf#retain()</p>
<p>retain() &#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x4F7F;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x52A0;&#x4E00;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">retain</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> retain0(<span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">retain</span><span class="params">(<span class="keyword">int</span> increment)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> retain0(checkPositive(increment, <span class="string">&quot;increment&quot;</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ByteBuf <span class="title">retain0</span><span class="params">(<span class="keyword">int</span> increment)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">int</span> refCnt = <span class="keyword">this</span>.refCnt;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> nextCnt = refCnt + increment;</span><br><span class="line">        <span class="comment">// &#x5982;&#x679C; refCnt = 0 &#x7684;&#x65F6;&#x5019; nextCont = increment&#xFF0C;&#x5C31;&#x5C31;&#x5E94;&#x8BE5;&#x88AB;&#x56DE;&#x6536;</span></span><br><span class="line">        <span class="comment">// Ensure we not resurrect (which means the refCnt was 0) and also that we encountered an overflow.</span></span><br><span class="line">        <span class="keyword">if</span> (nextCnt &lt;= increment) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalReferenceCountException(refCnt, increment);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// &#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x5230;&#x4E86;&#x81EA;&#x65CB;&#x9501;</span></span><br><span class="line">        <span class="keyword">if</span> (refCntUpdater.compareAndSet(<span class="keyword">this</span>, refCnt, nextCnt)) {</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>java.util.concurrent.atomic.AtomicIntegerFieldUpdater</p>
<blockquote>
<p>public abstract class AtomicIntegerFieldUpdater<t><br>extends Object<br>A reflection-based utility that enables atomic updates to designated volatile int fields of designated classes. This class is designed for use in atomic data structures in which several fields of the same node are independently subject to atomic updates.<br>Note that the guarantees of the compareAndSet method in this class are weaker than in other atomic classes. Because this class cannot ensure that all uses of the field are appropriate for purposes of atomic access, it can guarantee atomicity only with respect to other invocations of compareAndSet and set on the same updater.</t></p>
</blockquote>
<p>AtomicIntegerFieldUpdater&#x8981;&#x70B9;&#x7684;&#x603B;&#x7ED3;&#xFF1A;</p>
<ol>
<li>&#x66F4;&#x65B0;&#x5668;&#x5FC5;&#x987B;&#x662F;int&#x7C7B;&#x578B;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x4E0D;&#x80FD;&#x662F;&#x5176;&#x4ED6;&#x5305;&#x88C5;&#x7C7B;&#x578B;</li>
<li>&#x66F4;&#x65B0;&#x5668;&#x7684;&#x66F4;&#x65B0;&#x5FC5;&#x987B;&#x662F;volatile&#x7C7B;&#x578B;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x786E;&#x4FDD;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x7684;&#x5171;&#x4EAB;&#x53D8;&#x91CF;&#x65F6;&#x7684;&#x7ACB;&#x5373;&#x53EF;&#x89C1;&#x6027;</li>
<li>&#x53D8;&#x91CF;&#x4E0D;&#x80FD;&#x662F;static&#x7684;&#xFF0C;&#x5FC5;&#x987B;&#x662F;&#x5B9E;&#x4F8B;&#x53D8;&#x91CF;&#xFF0C;&#x56E0;&#x4E3A;Unsafe.objectFieldOffset() &#x65B9;&#x6CD5;&#x4E0D;&#x652F;&#x6301;&#x9759;&#x6001;&#x53D8;&#x91CF;&#xFF08;CAS&#x64CD;&#x4F5C;&#x672C;&#x8D28;&#x662F;&#x901A;&#x8FC7;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#x7684;&#x504F;&#x79FB;&#x6765;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#xFF09;</li>
<li>&#x66F4;&#x65B0;&#x5668;&#x53EA;&#x80FD;&#x4FEE;&#x6539;&#x5B83;&#x53EF;&#x89C1;&#x8303;&#x56F4;&#x5185;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x56E0;&#x4E3A;&#x66F4;&#x65B0;&#x5668;&#x662F;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x6765;&#x5F97;&#x5230;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#xFF0C;&#x5982;&#x679C;&#x53D8;&#x91CF;&#x4E0D;&#x53EF;&#x89C1;&#x5C31;&#x4F1A;&#x62A5;&#x9519;</li>
</ol>
<p>&#x5982;&#x679C;&#x66F4;&#x65B0;&#x7684;&#x53D8;&#x91CF;&#x65F6;&#x5305;&#x88C5;&#x7C7B;&#x578B;&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;AtomicReferenceFieldUpdater&#x6765;&#x8FDB;&#x884C;&#x66F4;&#x65B0;</p>
<p>java.util.concurrent.atomic.AtomicIntegerFieldUpdater#compareAndSet</p>
<blockquote>
<p>public abstract boolean compareAndSet(T obj,<br>                                      int expect,<br>                                      int update)<br>Atomically sets the field of the given object managed by this updater to the given updated value if the current value == the expected value. This method is guaranteed to be atomic with respect to other calls to compareAndSet and set, but not necessarily with respect to other changes in the field.<br>Parameters:<br>obj - An object whose field to conditionally set<br>expect - the expected value<br>update - the new value</p>
</blockquote>
<p>&#x4E00;&#x4E2A;&#x4E0D;&#x5B89;&#x5168;&#x7684;&#x66F4;&#x65B0;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/19 15:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicUpdateTest</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">                System.out.print(person.age++ + <span class="string">&quot; &quot;</span>); <span class="comment">// 1 6 7 5 4 2 3 1 8 9</span></span><br><span class="line">            }).start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>{</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;AtomicIntegerFieldUpdater</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/19 15:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicUpdateTest</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        AtomicIntegerFieldUpdater&lt;Person&gt; fieldUpdater = AtomicIntegerFieldUpdater.newUpdater(Person.class, <span class="string">&quot;age&quot;</span>);</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">                System.out.print(fieldUpdater.getAndIncrement(person) + <span class="string">&quot; &quot;</span>); <span class="comment">// 1 4 3 2 5 6 7 10 9 8 </span></span><br><span class="line">            }).start();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>{</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> age = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&#x5927;&#x6982;&#x6709;&#x4EE5;&#x4E0B;&#x4E24;&#x79CD;&#x5B57;&#x6BB5;&#x9002;&#x5408;&#x7528;Atomic*FieldUpdater:</p>
<p>&#x5927;&#x591A;&#x6570;&#x7528;&#x5230;&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x5728;&#x8BFB;&#x53D6;&#x5B57;&#x6BB5;&#x7684;&#x503C;, &#x4F46;&#x4ECD;&#x7136;&#x6709;&#x901A;&#x8FC7;CAS&#x66F4;&#x65B0;&#x5B57;&#x6BB5;&#x503C;&#x7684;&#x9700;&#x6C42;. &#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x7528;AtomicInteger&#x7684;&#x8BDD;&#x6BCF;&#x4E2A;&#x76F4;&#x63A5;&#x8BFB;&#x53D6;&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;&#x7684;&#x5730;&#x65B9;&#x90FD;&#x8981;&#x591A;&#x4E00;&#x6B21;.get()&#x8C03;&#x7528;, &#x7528;volatile&#x53C8;&#x6EE1;&#x8DB3;&#x4E0D;&#x4E86;&#x9700;&#x6C42;, &#x6240;&#x4EE5;&#x5C31;&#x7528;&#x5230;&#x4E86;AtomicIntegerFieldUpdater</p>
<p>&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;&#x6240;&#x5C5E;&#x7684;&#x7C7B;&#x4F1A;&#x88AB;&#x521B;&#x5EFA;&#x5927;&#x91CF;&#x7684;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;, &#x5982;&#x679C;&#x7528;AtomicInteger, &#x6BCF;&#x4E2A;&#x5B9E;&#x4F8B;&#x91CC;&#x9762;&#x90FD;&#x8981;&#x521B;&#x5EFA;AtomicInteger&#x5BF9;&#x8C61;, &#x4ECE;&#x800C;&#x591A;&#x51FA;&#x5185;&#x5B58;&#x6D88;&#x8017;. &#x6BD4;&#x5982;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#x7C7B;&#x7684;Node, &#x7528;AtomicReference&#x4FDD;&#x5B58;next&#x663E;&#x7136;&#x662F;&#x4E0D;&#x5408;&#x9002;&#x7684;.</p>
<p>&#x539F;&#x6587;&#xFF1A;<a href="https://blog.csdn.net/u012415542/article/details/80646605" target="_blank" rel="noopener">https://blog.csdn.net/u012415542/article/details/80646605</a> </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicIntegerFieldUpdater&lt;AbstractReferenceCountedByteBuf&gt; refCntUpdater =</span><br><span class="line">        AtomicIntegerFieldUpdater.newUpdater(AbstractReferenceCountedByteBuf.class, <span class="string">&quot;refCnt&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Reference-counted-objects"><a href="#Reference-counted-objects" class="headerlink" title="Reference counted objects"></a>Reference counted objects</h2><p>&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x6587;&#x6863;&#xFF1A;<a href="https://netty.io/wiki/reference-counted-objects.html" target="_blank" rel="noopener">Reference counted objects</a></p>
<h2 id="Netty-&#x5904;&#x7406;&#x5668;"><a href="#Netty-&#x5904;&#x7406;&#x5668;" class="headerlink" title="Netty &#x5904;&#x7406;&#x5668;"></a>Netty &#x5904;&#x7406;&#x5668;</h2><h3 id="&#x91CD;&#x8981;&#x6982;&#x5FF5;"><a href="#&#x91CD;&#x8981;&#x6982;&#x5FF5;" class="headerlink" title="&#x91CD;&#x8981;&#x6982;&#x5FF5;"></a>&#x91CD;&#x8981;&#x6982;&#x5FF5;</h3><ul>
<li>Netty &#x7684;&#x5904;&#x7406;&#x5668;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x4E24;&#x7C7B;&#xFF1A;&#x5165;&#x7AD9;&#x5904;&#x7406;&#x5668;&#x548C;&#x51FA;&#x7AD9;&#x5904;&#x7406;&#x5668;</li>
<li>&#x5165;&#x7AD9;&#x5904;&#x7406;&#x5668;&#x7684;&#x9876;&#x5C42;&#x662F; ChannelnboundHandler&#xFF0C;&#x51FA;&#x7AD9;&#x5904;&#x7406;&#x5668;&#x7684;&#x9876;&#x5C42;&#x662F; ChannelOutboundHandler</li>
<li>&#x6570;&#x636E;&#x5904;&#x7406;&#x65F6;&#x5E38;&#x7528;&#x7684;&#x5404;&#x79CD;&#x89E3;&#x7801;&#x5668;&#x672C;&#x8D28;&#x4E0A;&#x90FD;&#x662F;&#x5904;&#x7406;&#x5668;</li>
<li>&#x7F16;&#x89E3;&#x7801;&#x5668;&#xFF1A;&#x65E0;&#x8BBA;&#x6211;&#x4EEC;&#x5411;&#x7F51;&#x7EDC;&#x4E2D;&#x5199;&#x5165;&#x7684;&#x6570;&#x636E;&#x662F;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#xFF0C;&#x6570;&#x636E;&#x5728;&#x7F51;&#x7EDC;&#x4E2D;&#x4F20;&#x9012;&#x65F6;&#xFF0C;&#x5176;&#x90FD;&#x662F;&#x4EE5;&#x5B57;&#x8282;&#x6D41;&#x7684;&#x5F62;&#x5F0F;&#x5448;&#x73B0;&#xFF0C;&#x5C06;&#x6570;&#x636E;&#x6709;&#x539F;&#x672C;&#x7684;&#x5B57;&#x8282;&#x6D41;&#x7684;&#x64CD;&#x4F5C;&#x6210;&#x4E3A;&#x7F16;&#x7801;&#xFF08;encode&#xFF09;&#xFF0C;&#x5C06;&#x6570;&#x636E;&#x6709;&#x5B57;&#x8282;&#x8F6C;&#x5316;&#x4E3A;&#x5B83;&#x539F;&#x672C;&#x7684;&#x683C;&#x5F0F;&#x6216;&#x662F;&#x5176;&#x5B83;&#x7684;&#x64CD;&#x4F5C;&#x6210;&#x4E3A;&#x89E3;&#x7801;&#xFF08;decode&#xFF09;&#xFF0C;&#x7F16;&#x7801;&#x7EDF;&#x4E00;&#x79F0;&#x4E3A;&#xFF08;codec&#xFF09;</li>
<li>&#x7F16;&#x7801;&#xFF1A;&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x4E00;&#x79CD;&#x51FA;&#x7AD9;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x7F16;&#x7801;&#x4E00;&#x5B9A;&#x662F;&#x4E00;&#x79CD; ChannelOutboundHandler</li>
<li>&#x89E3;&#x7801;&#xFF1A;&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x4E00;&#x79CD;&#x5165;&#x7AD9;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x89E3;&#x7801;&#x4E00;&#x5B9A;&#x662F;&#x4E00;&#x79CD; ChannelInboundHandler</li>
<li>&#x5728; Netty &#x4E2D;&#xFF0C;&#x7F16;&#x7801;&#x5668;&#x901A;&#x5E38;&#x4EE5; xxxEncoder&#x547D;&#x540D;&#xFF1B;&#x89E3;&#x7801;&#x5668;&#x901A;&#x5E38;&#x4EE5;xxxDecoder&#x547D;&#x540D;</li>
</ul>
<h3 id="&#x7F16;&#x5199;&#x4E00;&#x4E2A;Long&#x7C7B;&#x578B;&#x7684;&#x89E3;&#x7801;&#x5668;"><a href="#&#x7F16;&#x5199;&#x4E00;&#x4E2A;Long&#x7C7B;&#x578B;&#x7684;&#x89E3;&#x7801;&#x5668;" class="headerlink" title="&#x7F16;&#x5199;&#x4E00;&#x4E2A;Long&#x7C7B;&#x578B;&#x7684;&#x89E3;&#x7801;&#x5668;"></a>&#x7F16;&#x5199;&#x4E00;&#x4E2A;Long&#x7C7B;&#x578B;&#x7684;&#x89E3;&#x7801;&#x5668;</h3><p>&#x7F16;&#x5199;&#x4E00;&#x4E2A;&#x89E3;&#x7801;&#x5668;&#x5728;&#x5BA2;&#x670D;&#x7AEF;&#x4E0E;&#x670D;&#x52A1;&#x7AEF;&#x4F20;&#x8F93;&#x4E00;&#x4E2A; Long &#x578B;&#x7684;&#x6570;&#x636E;&#xFF0C;Netty &#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86; ByteToMessageDecoder</p>
<p>io.netty.handler.codec.ByteToMessageDecoder</p>
<blockquote>
<p>io.netty.handler.codec<br>public abstract class ByteToMessageDecoder<br>extends ChannelInboundHandlerAdapter<br>ChannelInboundHandlerAdapter which decodes bytes in a stream-like fashion from one ByteBuf to an other Message type. For example here is an implementation which reads all readable bytes from the input ByteBuf and create a new ByteBuf.<br>      public class SquareDecoder extends ByteToMessageDecoder {<br>           @Override<br>          public void decode(ChannelHandlerContext ctx, ByteBuf in, List<object> out)<br>                  throws Exception {<br>              out.add(in.readBytes(in.readableBytes()));<br>          }<br>      }</object></p>
<p>Frame detection<br>Generally frame detection should be handled earlier in the pipeline by adding a DelimiterBasedFrameDecoder, FixedLengthFrameDecoder, LengthFieldBasedFrameDecoder, or LineBasedFrameDecoder.<br>If a custom frame decoder is required, then one needs to be careful when implementing one with ByteToMessageDecoder. Ensure there are enough bytes in the buffer for a complete frame by checking ByteBuf.readableBytes(). If there are not enough bytes for a complete frame, return without modifying the reader index to allow more bytes to arrive.<br>To check for complete frames without modifying the reader index, use methods like ByteBuf.getInt(int). One MUST use the reader index when using methods like ByteBuf.getInt(int). For example calling in.getInt(0) is assuming the frame starts at the beginning of the buffer, which is not always the case. Use in.getInt(in.readerIndex()) instead.<br>Pitfalls<br>Be aware that sub-classes of ByteToMessageDecoder MUST NOT annotated with @Sharable.<br>Some methods such as ByteBuf.readBytes(int) will cause a memory leak if the returned buffer is not released or added to the out List. Use derived buffers like ByteBuf.readSlice(int) to avoid leaking memory.</p>
</blockquote>
<p>MyByteToLongDecoder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 12:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyByteToLongDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">&quot;decode invoked!&quot;</span>);</span><br><span class="line">        System.out.println(in.readableBytes());</span><br><span class="line">        <span class="keyword">if</span> (in.readableBytes() &gt;= <span class="number">8</span>) {</span><br><span class="line">            out.add(in.readLong());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>MyLongToByteEncoder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 12:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLongToByteEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">Long</span>&gt;</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Long msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">&quot;encoder invoked!&quot;</span>);</span><br><span class="line">        System.out.println(msg);</span><br><span class="line">        out.writeLong(msg);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>&#x91CD;&#x8981;&#x7ED3;&#x8BBA;&#xFF1A;</strong></p>
<ol>
<li>&#x65E0;&#x8BBA;&#x662F;&#x7F16;&#x7801;&#x5668;&#x8FD8;&#x662F;&#x89E3;&#x7801;&#x5668;&#xFF0C;&#x5176;&#x6240;&#x63A5;&#x6536;&#x7684;&#x6D88;&#x606F;&#x7C7B;&#x578B;&#x5FC5;&#x987B;&#x8981;&#x4E0E;&#x5F85;&#x5904;&#x7406;&#x7684;&#x53C2;&#x6570;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#xFF0C;&#x5426;&#x5219;&#x8BE5;&#x7F16;&#x7801;&#x5668;&#x6216;&#x5219;&#x89E3;&#x7801;&#x5668;&#x4E0D;&#x4F1A;&#x88AB;&#x6267;&#x884C;</li>
<li>&#x5728;&#x89E3;&#x7801;&#x5668;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x89E3;&#x7801;&#x65F6;&#xFF0C;&#x4E00;&#x5B9A;&#x8981;&#x8BB0;&#x5F97;&#x5224;&#x65AD;&#x7F13;&#x51B2;&#xFF08;ByteBuf&#xFF09;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x662F;&#x5426;&#x8DB3;&#x591F;&#xFF0C;&#x5426;&#x5219;&#x5C06;&#x4F1A;&#x4EA7;&#x751F;&#x4E00;&#x4E9B;&#x95EE;&#x9898;</li>
</ol>
<h3 id="ReplayingDecoder"><a href="#ReplayingDecoder" class="headerlink" title="ReplayingDecoder"></a>ReplayingDecoder</h3><p>&#x6587;&#x6863;&#xFF1A;<a href="https://netty.io/4.1/api/io/netty/handler/codec/ReplayingDecoder.html" target="_blank" rel="noopener">https://netty.io/4.1/api/io/netty/handler/codec/ReplayingDecoder.html</a></p>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x7EE7;&#x627F;&#x8FD9;&#x4E2A;&#x7F16;&#x7801;&#x5668;&#xFF0C;&#x4ED6;&#x4F1A;&#x81EA;&#x52A8;&#x5E2E;&#x6211;&#x5224;&#x65AD;&#x662F;&#x5426;&#x53EF;&#x8BFB;&#xFF0C;&#x4EE3;&#x7801;&#x4E5F;&#x7B80;&#x5355;&#xFF0C;&#x7B80;&#x5316;&#x4E86;&#x6211;&#x4EEC;&#x7684;&#x5224;&#x65AD;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyByteToLongDecoder2</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">Void</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">&quot;MyByteToLongDecoder2 decode invoked!&quot;</span>);</span><br><span class="line">        out.add(in.readLong());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="LengthFieldBasedFrameDecoder"><a href="#LengthFieldBasedFrameDecoder" class="headerlink" title="LengthFieldBasedFrameDecoder"></a>LengthFieldBasedFrameDecoder</h3><p>io.netty.handler.codec.LengthFieldBasedFrameDecoder</p>
<p>&#x6587;&#x6863;&#xFF1A;<a href="https://netty.io/4.1/api/io/netty/handler/codec/LengthFieldBasedFrameDecoder.html" target="_blank" rel="noopener">https://netty.io/4.1/api/io/netty/handler/codec/LengthFieldBasedFrameDecoder.html</a></p>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x7528;&#x8BED;&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x7684;&#x89E3;&#x7801;&#x5668;</p>
<h3 id="TCP-&#x7C98;&#x5305;&#x62C6;&#x5305;"><a href="#TCP-&#x7C98;&#x5305;&#x62C6;&#x5305;" class="headerlink" title="TCP &#x7C98;&#x5305;&#x62C6;&#x5305;"></a>TCP &#x7C98;&#x5305;&#x62C6;&#x5305;</h3><p>&#x5982;&#x679C;&#x6211;&#x5199;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x6CA1;&#x6709;&#x5BF9;&#x7C98;&#x5305;&#x548C;&#x62C6;&#x5305;&#x505A;&#x7279;&#x6B8A;&#x5904;&#x7406;&#x7684;&#x8BDD;&#x5C31;&#x4F1A;&#x4EA7;&#x751F;&#x7C98;&#x5305;&#x548C;&#x62C6;&#x5305;&#x73B0;&#x8C61;</p>
<p><img src="/2019/01/22/Netty &#x6E90;&#x7801;&#x5206;&#x6790;&#xFF08;&#x4E94;&#xFF09;/Netty &#x6E90;&#x7801;&#x5206;&#x6790;&#xFF08;&#x4E94;&#xFF09;\timg.jpg" alt="timg"></p>
<blockquote>
<p><strong>&#x7C98;&#x5305;&#x3001;&#x62C6;&#x5305;&#x53D1;&#x751F;&#x539F;&#x56E0;</strong><br>&#x53D1;&#x751F;TCP&#x7C98;&#x5305;&#x6216;&#x62C6;&#x5305;&#x6709;&#x5F88;&#x591A;&#x539F;&#x56E0;&#xFF0C;&#x73B0;&#x5217;&#x51FA;&#x5E38;&#x89C1;&#x7684;&#x51E0;&#x70B9;&#xFF0C;&#x53EF;&#x80FD;&#x4E0D;&#x5168;&#x9762;&#xFF0C;&#x6B22;&#x8FCE;&#x8865;&#x5145;&#xFF0C;<br>1&#x3001;&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x5927;&#x4E8E;TCP&#x53D1;&#x9001;&#x7F13;&#x51B2;&#x533A;&#x5269;&#x4F59;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF0C;&#x5C06;&#x4F1A;&#x53D1;&#x751F;&#x62C6;&#x5305;&#x3002;<br>2&#x3001;&#x5F85;&#x53D1;&#x9001;&#x6570;&#x636E;&#x5927;&#x4E8E;MSS&#xFF08;&#x6700;&#x5927;&#x62A5;&#x6587;&#x957F;&#x5EA6;&#xFF09;&#xFF0C;TCP&#x5728;&#x4F20;&#x8F93;&#x524D;&#x5C06;&#x8FDB;&#x884C;&#x62C6;&#x5305;&#x3002;<br>3&#x3001;&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x5C0F;&#x4E8E;TCP&#x53D1;&#x9001;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5927;&#x5C0F;&#xFF0C;TCP&#x5C06;&#x591A;&#x6B21;&#x5199;&#x5165;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x6570;&#x636E;&#x4E00;&#x6B21;&#x53D1;&#x9001;&#x51FA;&#x53BB;&#xFF0C;&#x5C06;&#x4F1A;&#x53D1;&#x751F;&#x7C98;&#x5305;&#x3002;<br>4&#x3001;&#x63A5;&#x6536;&#x6570;&#x636E;&#x7AEF;&#x7684;&#x5E94;&#x7528;&#x5C42;&#x6CA1;&#x6709;&#x53CA;&#x65F6;&#x8BFB;&#x53D6;&#x63A5;&#x6536;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5C06;&#x53D1;&#x751F;&#x7C98;&#x5305;&#x3002;<br><strong>&#x7C98;&#x5305;&#x3001;&#x62C6;&#x5305;&#x89E3;&#x51B3;&#x529E;&#x6CD5;</strong><br>&#x901A;&#x8FC7;&#x4EE5;&#x4E0A;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x6E05;&#x695A;&#x4E86;&#x7C98;&#x5305;&#x6216;&#x62C6;&#x5305;&#x53D1;&#x751F;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x5462;&#xFF1F;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#x7684;&#x5173;&#x952E;&#x5728;&#x4E8E;&#x5982;&#x4F55;&#x7ED9;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x6DFB;&#x52A0;&#x8FB9;&#x754C;&#x4FE1;&#x606F;&#xFF0C;&#x5E38;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x6709;&#x5982;&#x4E0B;&#x51E0;&#x4E2A;&#xFF1A;<br>1&#x3001;&#x53D1;&#x9001;&#x7AEF;&#x7ED9;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x6DFB;&#x52A0;&#x5305;&#x9996;&#x90E8;&#xFF0C;&#x9996;&#x90E8;&#x4E2D;&#x5E94;&#x8BE5;&#x81F3;&#x5C11;&#x5305;&#x542B;&#x6570;&#x636E;&#x5305;&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x8FD9;&#x6837;&#x63A5;&#x6536;&#x7AEF;&#x5728;&#x63A5;&#x6536;&#x5230;&#x6570;&#x636E;&#x540E;&#xFF0C;&#x901A;&#x8FC7;&#x8BFB;&#x53D6;&#x5305;&#x9996;&#x90E8;&#x7684;&#x957F;&#x5EA6;&#x5B57;&#x6BB5;&#xFF0C;&#x4FBF;&#x77E5;&#x9053;&#x6BCF;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x7684;&#x5B9E;&#x9645;&#x957F;&#x5EA6;&#x4E86;&#x3002;<br>2&#x3001;&#x53D1;&#x9001;&#x7AEF;&#x5C06;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x5C01;&#x88C5;&#x4E3A;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#xFF08;&#x4E0D;&#x591F;&#x7684;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8865;0&#x586B;&#x5145;&#xFF09;&#xFF0C;&#x8FD9;&#x6837;&#x63A5;&#x6536;&#x7AEF;&#x6BCF;&#x6B21;&#x4ECE;&#x63A5;&#x6536;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x8BFB;&#x53D6;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x6570;&#x636E;&#x5C31;&#x81EA;&#x7136;&#x800C;&#x7136;&#x7684;&#x628A;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x5305;&#x62C6;&#x5206;&#x5F00;&#x6765;&#x3002;<br>3&#x3001;&#x53EF;&#x4EE5;&#x5728;&#x6570;&#x636E;&#x5305;&#x4E4B;&#x95F4;&#x8BBE;&#x7F6E;&#x8FB9;&#x754C;&#xFF0C;&#x5982;&#x6DFB;&#x52A0;&#x7279;&#x6B8A;&#x7B26;&#x53F7;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x63A5;&#x6536;&#x7AEF;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x8FB9;&#x754C;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x4E0D;&#x540C;&#x7684;&#x6570;&#x636E;&#x5305;&#x62C6;&#x5206;&#x5F00;&#x3002;</p>
<p>&#x4F5C;&#x8005;&#xFF1A;wxy941011<br>&#x6765;&#x6E90;&#xFF1A;CSDN<br>&#x539F;&#x6587;&#xFF1A;<a href="https://blog.csdn.net/wxy941011/article/details/80428470" target="_blank" rel="noopener">https://blog.csdn.net/wxy941011/article/details/80428470</a><br>&#x7248;&#x6743;&#x58F0;&#x660E;&#xFF1A;&#x672C;&#x6587;&#x4E3A;&#x535A;&#x4E3B;&#x539F;&#x521B;&#x6587;&#x7AE0;&#xFF0C;&#x8F6C;&#x8F7D;&#x8BF7;&#x9644;&#x4E0A;&#x535A;&#x6587;&#x94FE;&#x63A5;&#xFF01;</p>
</blockquote>
<h3 id="&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x89E3;&#x51B3;&#x7C98;&#x5305;&#x548C;&#x62C6;&#x5305;"><a href="#&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x89E3;&#x51B3;&#x7C98;&#x5305;&#x548C;&#x62C6;&#x5305;" class="headerlink" title="&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x89E3;&#x51B3;&#x7C98;&#x5305;&#x548C;&#x62C6;&#x5305;"></a>&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x89E3;&#x51B3;&#x7C98;&#x5305;&#x548C;&#x62C6;&#x5305;</h3><p>&#x4E00;&#x4E2A; Person &#x534F;&#x8BAE;&#x7C7B;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 16:00</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5173;&#x4E8E; Person &#x7684;&#x534F;&#x8BAE;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonProtocol</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLength</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> length;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLength</span><span class="params">(<span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.length = length;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getContent() {</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(<span class="keyword">byte</span>[] content)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x89E3;&#x7801;&#x5904;&#x7406;&#x5668;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 16:04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPersonDecoder</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">Void</span>&gt;</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">&quot;MyPersonDecoder decode invoked!&quot;</span>);</span><br><span class="line">        <span class="comment">// Gets a 32-bit integer at the current {@code readerIndex}</span></span><br><span class="line">        <span class="comment">// and increases the {@code readerIndex} by {@code 4} in this buffer.</span></span><br><span class="line">        <span class="keyword">int</span> length = in.readInt();</span><br><span class="line">        <span class="keyword">byte</span>[] content = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">        <span class="comment">// Transfers this buffer&apos;s data to the specified destination starting at</span></span><br><span class="line">        <span class="comment">// the current {@code readerIndex} and increases the {@code readerIndex}</span></span><br><span class="line">        <span class="comment">// by the number of the transferred bytes (= {@code dst.length}</span></span><br><span class="line">        in.readBytes(content);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#x628A;&#x5185;&#x5BB9;&#x6DFB;&#x52A0;&#x5230;&#x534F;&#x8BAE;&#x4E2D;</span></span><br><span class="line">        PersonProtocol personProtocol = <span class="keyword">new</span> PersonProtocol();</span><br><span class="line">        personProtocol.setLength(length);</span><br><span class="line">        personProtocol.setContent(content);</span><br><span class="line"></span><br><span class="line">        out.add(personProtocol);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7F16;&#x7801;&#x5904;&#x7406;&#x5668;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 16:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPersonEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">PersonProtocol</span>&gt;</span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, PersonProtocol msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">&quot;MyPersonEncoder encoder invoked!&quot;</span>);</span><br><span class="line">        <span class="comment">// &#x6D88;&#x606F;&#x5934;</span></span><br><span class="line">        out.writeInt(msg.getLength());</span><br><span class="line">        <span class="comment">// &#x6D88;&#x606F;&#x4F53;</span></span><br><span class="line">        out.writeBytes(msg.getContent());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x670D;&#x52A1;&#x7AEF;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 16:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line"></span><br><span class="line">        ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        serverBootstrap.group(bossGroup, workGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                        ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> MyPersonDecoder());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> MyPersonEncoder());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> MyServerHandler());</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">8899</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workGroup.shutdownGracefully();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 16:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">PersonProtocol</span>&gt;</span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, PersonProtocol msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">int</span> length = msg.getLength();</span><br><span class="line">        <span class="keyword">byte</span>[] content = msg.getContent();</span><br><span class="line">        System.out.println(<span class="string">&quot;&#x670D;&#x52A1;&#x7AEF;&#x63A5;&#x6536;&#x5230;&#x7684;&#x6570;&#x636E;&#xFF1A;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;&#x957F;&#x5EA6;&#xFF1A;&quot;</span> + length);</span><br><span class="line">        System.out.println(<span class="string">&quot;&#x5185;&#x5BB9;&#xFF1A;&quot;</span> + <span class="keyword">new</span> String(content, Charset.forName(<span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">        System.out.println(<span class="string">&quot;&#x670D;&#x52A1;&#x5668;&#x63A5;&#x6536;&#x5230;&#x7684;&#x6D88;&#x606F;&#x6570;&#x91CF;&#xFF1A;&quot;</span> + (++<span class="keyword">this</span>.count));</span><br><span class="line"></span><br><span class="line">        PersonProtocol personProtocol = <span class="keyword">new</span> PersonProtocol();</span><br><span class="line">        String resp = <span class="string">&quot;hello, world&quot;</span>;</span><br><span class="line">        personProtocol.setLength(resp.getBytes(<span class="string">&quot;utf-8&quot;</span>).length);</span><br><span class="line">        personProtocol.setContent(resp.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">        ctx.writeAndFlush(personProtocol);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5BA2;&#x670D;&#x7AEF;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClient</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        EventLoopGroup eventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            bootstrap.group(eventLoopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() {</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> MyPersonDecoder());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> MyPersonEncoder());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> MyClientHandler());</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line"></span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(<span class="string">&quot;localhost&quot;</span>,<span class="number">8899</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            eventLoopGroup.shutdownGracefully();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: cuzz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22 16:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">PersonProtocol</span>&gt;</span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, PersonProtocol msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">int</span> length = msg.getLength();</span><br><span class="line">        <span class="keyword">byte</span>[] content = msg.getContent();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;&#x5BA2;&#x6237;&#x7AEF;&#x63A5;&#x6536;&#x7684;&#x6D88;&#x606F;&#xFF1A;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;&#x6D88;&#x606F;&#x7684;&#x957F;&#x5EA6;&#xFF1A;&quot;</span> + length);</span><br><span class="line">        System.out.println(<span class="string">&quot;&#x6D88;&#x606F;&#x7684;&#x5185;&#x5BB9;&#xFF1A;&quot;</span> + <span class="keyword">new</span> String(content, Charset.forName(<span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">        System.out.println(<span class="string">&quot;&#x5BA2;&#x6237;&#x7AEF;&#x63A5;&#x6536;&#x5230;&#x7684;&#x6D88;&#x606F;&#x6570;&#x91CF;&#xFF1A;&quot;</span> + (++count));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            String messageToBeSend = <span class="string">&quot;send form client&quot;</span>;</span><br><span class="line">            PersonProtocol personProtocol = <span class="keyword">new</span> PersonProtocol();</span><br><span class="line">            personProtocol.setLength(messageToBeSend.getBytes(<span class="string">&quot;utf-8&quot;</span>).length);</span><br><span class="line">            personProtocol.setContent(messageToBeSend.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            ctx.writeAndFlush(personProtocol);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x8FD9;&#x91CC;&#x5173;&#x4E8E; Netty &#x7684;&#x8FD9;&#x4E94;&#x7BC7;&#x5206;&#x6790;&#x90FD;&#x662F;&#x770B;&#x7684;&#x5723;&#x601D;&#x56ED;&#x5F20;&#x9F99;&#x8001;&#x5E08;&#x7684;&#x8BFE;&#x7A0B;&#x81EA;&#x5DF1;&#x6240;&#x5199;&#x4E0B;&#x7684;&#x7B14;&#x8BB0;&#xFF0C;&#x81EA;&#x5DF1;&#x5BF9; Netty &#x6709;&#x4E86;&#x7B80;&#x5355;&#x7684;&#x8BA4;&#x8BC6;&#xFF0C;&#x4E5F;&#x5BF9; NIO &#x6709;&#x4E86;&#x66F4;&#x6DF1;&#x7684;&#x4E86;&#x89E3;&#xFF0C;&#x6700;&#x4E3B;&#x8981;&#x7684;&#x5B66;&#x4F1A;&#x770B;&#x82F1;&#x6587;&#x6587;&#x6863;&#xFF0C;&#x770B;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x5F88;&#x91CD;&#x8981;&#xFF0C;&#x4E0D;&#x8981;&#x60E7;&#x6015;&#xFF0C;&#x6162;&#x6162;&#x7684;&#x5C31;&#x611F;&#x89C9;&#x8FD8;&#x662F;&#x6587;&#x6863;&#x5199;&#x7684;&#x6700;&#x6E05;&#x695A;&#xFF0C;&#x6700;&#x6709;&#x4EF7;&#x503C;&#x3002;&#x8001;&#x5E08;&#x8FD8;&#x63D0;&#x5230;&#x9700;&#x8981;&#x591A;&#x8BB0;&#x5F55;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4E5F;&#x628A;&#x4E00;&#x4E9B;&#x91CD;&#x8981;&#x7684;&#x77E5;&#x8BC6;&#x70B9;&#x8BB0;&#x5F55;&#x4E0B;&#x6765;&#xFF0C;&#x65B9;&#x4FBF;&#x4EE5;&#x540E;&#x67E5;&#x627E;&#x3002;&#x5F53;&#x7136;&#x4EE5;&#x540E;&#x8FD8;&#x8981;&#x52A0;&#x5F3A;&#x5B66;&#x4E60;&#xFF0C;&#x591A;&#x770B;&#x770B; Netty &#x5B98;&#x65B9;&#x6587;&#x6863;&#x548C;&#x4F8B;&#x5B50;&#xFF0C;&#x52A0;&#x5F3A;&#x7EC3;&#x4E60;&#x3002;</p>

      
    </div>
    
    
    


<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
  
</div>
<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2019/01/22/Netty 源码分析（五）/">Netty 源码分析（五）</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 cuzz 的个人博客">cuzz</a></p>
  <p><span>发布时间:</span>2019年01月22日 - 17:01</p>
  <p><span>最后更新:</span>2019年07月16日 - 19:07</p>
  <p><span>原始链接:</span><a href="/2019/01/22/Netty 源码分析（五）/" title="Netty 源码分析（五）">http://blog.cuzz.site/2019/01/22/Netty 源码分析（五）/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://blog.cuzz.site/2019/01/22/Netty 源码分析（五）/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>

      
</div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>请博主吃包辣条</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="cuzz 微信支付">
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/源码/" rel="tag"><i class="fa fa-tag"></i> 源码</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/19/Netty 源码分析（四）/" rel="next" title="Netty 源码分析（四）">
                <i class="fa fa-chevron-left"></i> Netty 源码分析（四）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/26/Brief History of HTTP/" rel="prev" title="Brief History of HTTP">
                Brief History of HTTP <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2154292" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
	<div id="gitalk-container"></div>
	
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="cuzz">
            
              <p class="site-author-name" itemprop="name">cuzz</p>
              <p class="site-description motion-element" itemprop="description">爱分享，爱技术，爱生活。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/cuzz1" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/7106f93fb795" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-book"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.bing.com" title="必应" target="_blank">必应</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ReferenceCounted"><span class="nav-number">1.</span> <span class="nav-text">ReferenceCounted</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AbstractReferenceCountedByteBuf"><span class="nav-number">1.1.</span> <span class="nav-text">AbstractReferenceCountedByteBuf</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#retain"><span class="nav-number">1.1.1.</span> <span class="nav-text">retain()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference-counted-objects"><span class="nav-number">2.</span> <span class="nav-text">Reference counted objects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netty-处理器"><span class="nav-number">3.</span> <span class="nav-text">Netty 处理器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重要概念"><span class="nav-number">3.1.</span> <span class="nav-text">重要概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写一个Long类型的解码器"><span class="nav-number">3.2.</span> <span class="nav-text">编写一个Long类型的解码器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReplayingDecoder"><span class="nav-number">3.3.</span> <span class="nav-text">ReplayingDecoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LengthFieldBasedFrameDecoder"><span class="nav-number">3.4.</span> <span class="nav-text">LengthFieldBasedFrameDecoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-粘包拆包"><span class="nav-number">3.5.</span> <span class="nav-text">TCP 粘包拆包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义协议解决粘包和拆包"><span class="nav-number">3.6.</span> <span class="nav-text">自定义协议解决粘包和拆包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cuzz</span>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共138.6k字</span>
</div>
  
</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   
   <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'e829281603f9115c572d',
          clientSecret: '246dae10dfb1b363805ab98902dc93539c355bb3',
          repo: 'cuzz1.github.io',
          owner: 'cuzz1',
          admin: ['cuzz1'],
          id: decodeURI(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "default";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
<div id="hexo-helper-live2d">
  <canvas id="live2dcanvas" width="150" height="300"></canvas>
</div>
<style>
  #live2dcanvas{
    position: fixed;
    width: 150px;
    height: 300px;
    opacity:0.7;
    right: -30px;
    z-index: 999;
    pointer-events: none;
    bottom: 10px;
  }
</style>
<script type="text/javascript" src="/live2d/device.min.js"></script>
<script type="text/javascript">
const loadScript = function loadScript(c,b){var a=document.createElement("script");a.type="text/javascript";"undefined"!=typeof b&&(a.readyState?a.onreadystatechange=function(){if("loaded"==a.readyState||"complete"==a.readyState)a.onreadystatechange=null,b()}:a.onload=function(){b()});a.src=c;document.body.appendChild(a)};
(function(){
  if((typeof(device) != 'undefined') && (device.mobile())){
    var trElement = document.getElementById('hexo-helper-live2d');
    trElement.parentNode.removeChild(trElement);
    return;
  }else
    if (typeof(device) === 'undefined') console.error('Cannot find current-device script.');
  loadScript("/live2d/script.js", function(){loadlive2d("live2dcanvas", "/live2d/assets/tororo.model.json", 0.5);});
})();
</script>

</body>
</html>
<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/src/love.js"></script>
